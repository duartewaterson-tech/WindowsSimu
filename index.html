<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Web Simulator - Ultimate Edition</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS Reset & Base --- */
        :root {
            /* Variáveis Win7/Aero */
            --glass-color: rgba(20, 30, 50, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --win-header-start: rgba(255, 255, 255, 0.8);
            --win-header-end: rgba(200, 200, 200, 0.4);
            --taskbar-color: rgba(10, 20, 35, 0.9);
            --selection-blue: rgba(0, 120, 215, 0.4);
            --selection-border: rgba(0, 120, 215, 0.7);

            /* Variáveis Win8 */
            --win8-accent: #4b2c89; /* Roxo padrão */
            --win8-bg-pattern: url('https://grainy-gradients.vercel.app/noise.svg');

            /* Variáveis Win10 */
            --win10-taskbar: rgba(16, 16, 16, 0.95);
            --win10-bg: rgba(30, 30, 30, 0.95);
            --win10-accent: #0078d7;

            /* Variáveis Win11 */
            --win11-bg: rgba(243, 243, 243, 0.85);
            --win11-dark: rgba(32, 32, 32, 0.9);
            --win11-taskbar: rgba(255, 255, 255, 0.85);
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }

        /* --- DARK MODE STYLES (Win 10/11) --- */
        body.dark-mode.theme-win10 .window,
        body.dark-mode.theme-win11 .window {
            background: #202020;
            color: #fff;
            border-color: #444;
        }
        body.dark-mode.theme-win10 .window-header,
        body.dark-mode.theme-win11 .window-header {
            background: #2d2d2d;
            color: #fff;
            border-bottom: 1px solid #333;
        }
        body.dark-mode.theme-win10 .window-title,
        body.dark-mode.theme-win11 .window-title {
            color: #fff;
        }
        body.dark-mode.theme-win10 .window-content,
        body.dark-mode.theme-win11 .window-content {
            background: #1a1a1a;
            color: #ddd;
            border-color: #333;
        }
        body.dark-mode.theme-win10 .win-btn,
        body.dark-mode.theme-win11 .win-btn {
            background: transparent;
            color: #fff;
        }
        body.dark-mode.theme-win10 .win-btn:hover,
        body.dark-mode.theme-win11 .win-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        body.dark-mode.theme-win10 .win-close:hover,
        body.dark-mode.theme-win11 .win-close:hover {
            background: #c42b1c;
        }

        /* Dark Mode - Settings & Explorer Internal Override */
        body.dark-mode .settings-content,
        body.dark-mode .settings-nav-bar,
        body.dark-mode .settings-option-card {
            background: #202020;
            color: #fff;
            border-color: #444;
        }
        body.dark-mode .settings-option-card:hover {
            background: #333;
        }
        body.dark-mode .settings-option-card span {
            color: #fff;
        }
        body.dark-mode .settings-back-btn {
            color: #fff;
        }
        body.dark-mode .explorer-sidebar,
        body.dark-mode .explorer-top,
        body.dark-mode .explorer-main,
        body.dark-mode .explorer-bar {
            background: #252525;
            color: #fff;
            border-color: #444;
        }
        body.dark-mode .explorer-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }
        body.dark-mode .explorer-item span {
            color: #ddd;
        }
        body.dark-mode .explorer-tree-item {
            color: #ddd;
        }

        /* Dark Mode - Win 11 Specifics */
        body.dark-mode.theme-win11 #taskbar {
            background: rgba(30, 30, 30, 0.85);
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        body.dark-mode.theme-win11 #start-menu-11 {
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
        }
        body.dark-mode.theme-win11 .s11-search {
            background: #333;
            border: 1px solid #444;
            border-bottom: 2px solid #0078d7;
        }
        body.dark-mode.theme-win11 .s11-search input {
            color: #fff;
        }
        body.dark-mode.theme-win11 .s11-section-title {
            color: #eee;
        }
        body.dark-mode.theme-win11 .s11-item i {
            color: #fff;
        }
        body.dark-mode.theme-win11 .s11-item span {
            color: #eee;
        }
        body.dark-mode.theme-win11 .s11-item:hover {
            background: rgba(255,255,255,0.1);
        }
        body.dark-mode.theme-win11 .s11-rec-name, 
        body.dark-mode.theme-win11 .s11-rec-meta,
        body.dark-mode.theme-win11 .s11-user,
        body.dark-mode.theme-win11 .s11-power {
            color: #eee;
        }
        body.dark-mode.theme-win11 .s11-rec-item:hover,
        body.dark-mode.theme-win11 .s11-user:hover,
        body.dark-mode.theme-win11 .s11-power:hover {
            background: rgba(255,255,255,0.1);
        }
        body.dark-mode.theme-win11 .s11-btn-all {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        body.dark-mode.theme-win11 .s11-footer {
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* Dark Mode - Win 10 Specifics */
        body.dark-mode.theme-win10 #start-menu-10 {
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid #333;
        }
        body.dark-mode.theme-win10 #win10-search-bar {
            background: #333;
            color: #fff;
        }
        body.dark-mode.theme-win10 #win10-search-bar input {
            background: transparent;
            color: #fff;
        }
        body.dark-mode.theme-win10 #win10-search-bar i {
            color: #aaa;
        }
        body.dark-mode.theme-win10 .s10-list-item:hover,
        body.dark-mode.theme-win10 .s10-side-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        /* --- END DARK MODE --- */

        /* --- Wallpaper --- */
        #desktop {
            width: 100%;
            height: calc(100% - 40px);
            background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920') no-repeat center center fixed; 
            background-size: cover;
            position: relative;
        }

        /* --- Context Menu --- */
        #context-menu {
            position: absolute;
            background: #f0f0f0;
            border: 1px solid #979797;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            min-width: 200px;
            z-index: 100000;
            display: none;
            font-size: 12px;
            color: #000;
            padding: 2px;
            border-radius: 2px;
        }

        .ctx-item {
            padding: 2px 25px 2px 30px; /* Left padding for icon gutter */
            cursor: default;
            position: relative;
            display: flex;
            align-items: center;
            height: 26px;
            border: 1px solid transparent;
        }

        .ctx-item:hover {
            background: linear-gradient(to bottom, #ecf6fd, #dcebf9);
            border: 1px solid #b8d6fb;
            border-radius: 2px;
        }

        .ctx-icon {
            position: absolute;
            left: 5px;
            width: 20px;
            text-align: center;
            color: #333;
        }

        .ctx-arrow {
            position: absolute;
            right: 8px;
            font-size: 8px;
            color: #333;
        }

        .ctx-separator {
            height: 1px;
            background: #d9d9d9;
            margin: 3px 10px;
            border-bottom: 1px solid #fff;
        }

        /* Submenu */
        .ctx-submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            width: 200px;
            background: #f0f0f0;
            border: 1px solid #979797;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            display: none;
            padding: 2px;
            margin-left: -2px;
        }

        .ctx-item:hover > .ctx-submenu {
            display: block;
        }

        /* --- Marquise (Retângulo de Seleção) --- */
        #selection-box {
            position: absolute;
            background: var(--selection-blue);
            border: 1px solid var(--selection-border);
            pointer-events: none;
            display: none;
            z-index: 1000;
        }

        /* --- BSOD (Tela Azul) --- */
        #bsod {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000082;
            color: #fff;
            font-family: 'Lucida Console', monospace;
            z-index: 999999;
            padding: 50px;
            font-size: 18px;
            line-height: 1.5;
            cursor: pointer;
        }
        
        /* BSOD Win 8/10/11 Style */
        body.theme-win8 #bsod, body.theme-win10 #bsod, body.theme-win11 #bsod {
            background: #0078d7; /* Win10/11 also blue, somewhat similar */
            font-family: 'Segoe UI', sans-serif;
            display: none; /* Logic handles display */
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 100px;
        }
        body.theme-win11 #bsod { background: #000; } /* Win11 BSOD is often black initially then updated to blue */

        /* --- Desktop Icons --- */
        .desktop-icon {
            width: 80px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 4px;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            transition: background 0.2s, transform 0.2s;
            position: absolute;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .desktop-icon.selected {
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .desktop-icon i {
            font-size: 36px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            transition: font-size 0.2s;
        }

        .desktop-icon span {
            font-size: 11px;
            line-height: 1.2;
        }

        .icon-trash { color: #e6e6e6; }
        .icon-computer { color: #5bc0de; }
        .icon-docs { color: #f0ad4e; }
        .icon-ie { color: #1E90FF; }
        .icon-snake { color: #5cb85c; }
        .icon-calc { color: #95a5a6; }
        .icon-settings { color: #999; }
        .icon-hub { color: #f1c40f; }
        .icon-paint { color: #e74c3c; }
        .icon-cmd { color: #333; }
        .icon-danger { color: #c0392b; }
        .icon-store { color: #fff; background: linear-gradient(135deg, #f25022 0%, #7fba00 25%, #00a4ef 50%, #ffb900 75%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        /* --- Taskbar --- */
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: var(--taskbar-color);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            transition: background 0.5s;
        }

        #start-button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: radial-gradient(circle at center, #00f0ff 0%, #004080 80%, #001030 100%);
            box-shadow: 0 0 8px rgba(0,240,255,0.6), inset 0 0 5px rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 15px;
            transition: filter 0.2s, transform 0.1s;
        }

        #start-button:hover { filter: brightness(1.2); }
        #start-button:active { transform: scale(0.95); }
        
        #start-button i { color: white; font-size: 20px; }

        #task-container {
            flex-grow: 1;
            display: flex;
            gap: 5px;
        }

        #win11-search-icon { display: none; } /* Hidden by default */
        #win10-search-bar { display: none; } /* Hidden by default */

        .task-item {
            width: 160px;
            height: 34px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: inset 0 0 5px rgba(255,255,255,0.1);
        }

        .task-item:hover { background: rgba(255,255,255,0.25); }

        .task-item.active {
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            border-color: rgba(255,255,255,0.5);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.2);
        }

        #tray {
            width: 110px;
            text-align: right;
            font-size: 11px;
            padding-right: 8px;
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        /* --- Windows --- */
        .window {
            position: absolute;
            background: var(--glass-color);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 200px;
            min-height: 100px;
            animation: openWin 0.2s ease-out;
            transition: background 0.5s;
        }

        @keyframes openWin {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .window-header {
            height: 34px;
            background: linear-gradient(to bottom, var(--win-header-start), var(--win-header-end));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        .window-title { font-size: 13px; color: #000; font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .window-title i { font-size: 14px; text-shadow: none; }
        .window-title img { width: 16px; height: 16px; }

        .win-controls { display: flex; gap: 4px; }
        .win-btn {
            width: 28px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #000;
            background: linear-gradient(to bottom, #fff, #ddd);
            border: 1px solid #999;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .win-btn:hover { filter: brightness(1.1); }
        .win-close { background: linear-gradient(to bottom, #e81123, #c00); color: white; border-color: #a00; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .win-close:hover { background: #ff4d4d; }

        .window-content {
            flex-grow: 1;
            background: #fff;
            color: #000;
            margin: 0 5px 5px 5px;
            overflow: auto;
            position: relative;
            border: 1px solid #aaa;
        }

        /* --- Gaming Hub UI --- */
        .hub-container { padding: 20px; background: #fdfdfd; height: 100%; }
        .hub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px; }
        .hub-item { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 15px; border: 1px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .hub-item:hover { background: #eef5fb; border-color: #0078d7; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .hub-item i { font-size: 48px; }
        .hub-item span { font-size: 12px; font-weight: 600; color: #333; }

        /* --- Run Window UI --- */
        .run-box { padding: 15px; font-size: 12px; display: flex; flex-direction: column; gap: 15px; background: #f0f0f0; height: 100%; }
        .run-header { display: flex; gap: 15px; align-items: flex-start; }
        .run-icon-large { width: 32px; height: 32px; flex-shrink: 0; }
        .run-prompt { color: #000; line-height: 1.4; }
        .run-input-area { display: flex; align-items: center; gap: 10px; }
        .run-field { flex-grow: 1; height: 22px; border: 1px solid #7a7a7a; padding: 0 5px; outline: none; font-size: 12px; }
        .run-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
        .win7-btn { min-width: 75px; padding: 4px; border: 1px solid #707070; background: #e1e1e1; cursor: pointer; border-radius: 3px; font-size: 12px; }
        .win7-btn:hover { background: #e5f1fb; border-color: #0078d7; }

        /* --- Start Menu (Classic / Win7) --- */
        #start-menu {
            position: absolute;
            bottom: 42px;
            left: 0;
            width: 400px;
            height: 520px;
            background: rgba(25, 45, 75, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            z-index: 10000;
            display: none;
            flex-direction: column;
            box-shadow: 4px -4px 15px rgba(0,0,0,0.5);
            transition: background 0.5s;
        }

        .start-top { flex-grow: 1; display: flex; padding: 8px 0 0 8px; }
        .start-left { width: 62%; background: #fff; border-radius: 3px; padding: 10px; display: flex; flex-direction: column; gap: 2px; border: 1px solid #777; }
        .start-right { width: 38%; padding: 10px; display: flex; flex-direction: column; gap: 12px; }

        .start-item { display: flex; align-items: center; gap: 10px; padding: 6px 8px; color: #333; font-size: 12px; cursor: pointer; border-radius: 3px; }
        .start-item:hover { background: linear-gradient(to bottom, #e0f0ff, #c0e0ff); border: 1px solid #a0c0e0; margin: -1px; }
        .start-item i { font-size: 24px; width: 26px; text-align: center; }

        .start-right-item { color: #fff; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 3px; }
        .start-right-item:hover { background: rgba(255,255,255,0.15); box-shadow: 0 0 2px rgba(255,255,255,0.3); }

        .start-bottom {
            height: 46px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            background: linear-gradient(to top, #1e2e40, #3c5a78);
            border-radius: 0 0 5px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .search-bar {
            background: #fff;
            border: 1px solid #555;
            border-radius: 3px;
            flex-grow: 1;
            height: 26px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .search-bar input { border: none; outline: none; width: 100%; font-size: 11px; font-style: italic; color: #666; }

        .shutdown-btn { background: linear-gradient(to bottom, #f0ad4e, #d9534f); border: 1px solid #b9403d; color: #fff; font-size: 11px; padding: 5px 12px; border-radius: 3px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .shutdown-btn:hover { filter: brightness(1.1); }

        /* --- Browser UI --- */
        .browser-toolbar { height: 40px; background: #f0f0f0; display: flex; align-items: center; padding: 0 10px; gap: 8px; border-bottom: 1px solid #ccc; }
        .browser-address { flex-grow: 1; height: 26px; background: #fff; border: 1px solid #ccc; padding: 0 10px; display: flex; align-items: center; font-size: 12px; }

        /* --- Microsoft Store UI --- */
        .store-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            font-family: 'Segoe UI', sans-serif;
            background: #fff;
        }
        .store-header {
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .store-header h2 { margin: 0; font-weight: 600; font-size: 18px; color: #333; }
        .store-nav { display: flex; gap: 20px; font-size: 13px; color: #555; margin-left: 20px; }
        .store-nav span { cursor: pointer; position: relative; }
        .store-nav span:hover { color: #0078d7; }
        .store-nav span.active { color: #000; font-weight: 600; }
        .store-nav span.active::after {
            content: ''; position: absolute; bottom: -18px; left: 0; width: 100%; height: 3px; background: #0078d7;
        }
        .store-content {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .store-section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #333; }
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .store-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.2s;
        }
        .store-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #ccc; }
        .store-icon-box {
            width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;
            border-radius: 10px;
        }
        .store-card h3 { margin: 5px 0; font-size: 14px; font-weight: 600; }
        .store-card p { margin: 0 0 15px 0; font-size: 11px; color: #666; }
        .store-btn {
            background: #0078d7; color: white; border: none; padding: 6px 20px; border-radius: 4px; font-size: 12px; cursor: pointer;
            transition: background 0.2s;
            margin-top: auto;
            width: 100%;
        }
        .store-btn:hover { background: #0063b1; }
        .store-btn:disabled { background: #ccc; cursor: default; }

        /* --- Explorer UI --- */
        .explorer-top { height: 35px; background: #f0f0f0; border-bottom: 1px solid #d9d9d9; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .explorer-bar { flex-grow: 1; height: 24px; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; padding-left: 5px; font-size: 12px; color: #333; }
        .explorer-container { display: flex; height: calc(100% - 35px); }
        .explorer-sidebar { width: 180px; background: #f5f5f5; border-right: 1px solid #d9d9d9; padding: 10px; font-size: 12px; }
        .explorer-main { flex-grow: 1; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 15px; background: #fff; }
        .explorer-item { width: 80px; text-align: center; cursor: pointer; padding: 5px; border: 1px solid transparent; border-radius: 3px; }
        .explorer-item:hover { background: #e5f3ff; border: 1px solid #cce8ff; }
        .explorer-item i { font-size: 36px; color: #ffcc00; display: block; margin-bottom: 5px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .explorer-item span { font-size: 11px; color: #333; word-break: break-all; }
        .explorer-tree-item { padding: 4px 0; cursor: pointer; display: flex; align-items: center; gap: 6px; color: #333; }
        .explorer-tree-item:hover { color: #0078d7; text-decoration: underline; }

        /* --- Calculator --- */
        .calc-body { height: 100%; background: #d9e4f1; display: flex; flex-direction: column; padding: 10px; }
        .calc-display { background: linear-gradient(#fff, #eef); border: 1px solid #888; height: 50px; margin-bottom: 10px; border-radius: 3px; text-align: right; font-size: 24px; padding: 5px 10px; line-height: 40px; color: #000; overflow: hidden; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; flex-grow: 1; }
        .calc-btn { background: linear-gradient(#fff, #e0e0e0); border: 1px solid #999; border-radius: 3px; cursor: pointer; font-size: 14px; color: #000; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
        .calc-btn:hover { background: linear-gradient(#fff, #f0c080); border-color: #f0ad4e; }
        .calc-btn:active { background: #e0a060; transform: translateY(1px); }
        .calc-btn.op { font-weight: bold; }
        .calc-btn.eq { grid-column: span 2; background: linear-gradient(#f0f0f0, #ccc); }

        /* --- Paint --- */
        .paint-container { display: flex; flex-direction: column; height: 100%; background: #f0f0f0; }
        .paint-toolbar { height: 60px; background: #e6e6e6; border-bottom: 1px solid #aaa; display: flex; align-items: center; padding: 0 10px; gap: 15px; }
        .paint-canvas-area { flex-grow: 1; overflow: auto; background: #ccc; padding: 10px; display: flex; justify-content: center; align-items: center; }
        .paint-canvas { background: #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); cursor: crosshair; }
        .color-picker { display: flex; flex-wrap: wrap; width: 140px; gap: 2px; }
        .color-box { width: 18px; height: 18px; border: 1px solid #888; cursor: pointer; }
        .color-box.active { border: 2px solid #000; transform: scale(1.1); }
        .tool-btn { width: 30px; height: 30px; border: 1px solid #999; background: #fff; cursor: pointer; display: flex; justify-content: center; align-items: center; border-radius: 3px; }
        .tool-btn:active, .tool-btn.active { background: #ccc; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); }

        /* --- CMD --- */
        .cmd-container { background: #000; color: #ccc; font-family: 'Consolas', monospace; height: 100%; padding: 5px; display: flex; flex-direction: column; font-size: 14px; }
        .cmd-log { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; }
        .cmd-input-line { display: flex; }
        .cmd-input { background: transparent; border: none; color: #ccc; font-family: inherit; flex-grow: 1; outline: none; font-size: inherit; }

        /* --- WinVer & Settings Styles --- */
        .winver-content { padding: 25px; font-size: 12px; line-height: 1.5; color: #333; background: #fff; height: 100%; }
        .winver-logo { font-size: 50px; color: #0078d7; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        
        textarea.notepad-area { width: 100%; height: 100%; border: none; resize: none; padding: 10px; font-family: 'Consolas', monospace; outline: none; font-size: 14px; }
        #snake-canvas { background: #111; display: block; margin: 0 auto; border: 2px solid #555; }
        
        /* Maze Specific */
        #maze-container { display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; background: #1a1a1a; height: 100%; overflow: auto; padding-bottom: 20px; }
        #maze-canvas { background: #000; border: 4px solid #333; image-rendering: pixelated; margin-top: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); align-self: center;}
        .maze-stats { width: 100%; padding: 10px; color: #0f0; font-family: monospace; display: flex; justify-content: space-between; background: #222; border-bottom: 1px solid #444; position: sticky; top: 0; z-index: 10; }

        .score-board { background: #111; color: #0f0; text-align: center; padding: 5px; font-family: monospace; border-bottom: 1px solid #333; }
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #f0f0f0; height: calc(100% - 30px); }
        .memory-card { height: 70px; background: #0078d7; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #fff; transition: transform 0.3s; }
        .memory-card.flipped { background: #fff; color: #0078d7; transform: rotateY(180deg); }
        .memory-card.matched { background: #2ecc71; cursor: default; }

        /* Settings */
        .settings-content { padding: 20px; color: #333; font-family: "Segoe UI", sans-serif; height: 100%; overflow-y: auto; background: #f5f5f5; }
        .settings-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-h2 { font-size: 16px; color: #0078d7; margin-bottom: 15px; font-weight: 600; }
        .bg-preview-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .bg-thumb { width: 100px; height: 60px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; background-size: cover; background-position: center; transition: transform 0.1s; }
        .bg-thumb:hover { transform: scale(1.05); border-color: #0078d7; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-top: 10px; }
        .upload-btn { border: 1px solid #777; color: #333; background-color: white; padding: 6px 15px; border-radius: 3px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .upload-btn:hover { background-color: #f0f0f0; border-color: #0078d7; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .color-swatch { width: 40px; height: 40px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .color-swatch:hover { transform: scale(1.1); border-color: #fff; }
        .settings-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .settings-option-card { background: #fff; border: 1px solid #d9d9d9; border-radius: 4px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .settings-option-card:hover { border-color: #0078d7; background: #f0f8ff; }
        .settings-option-card i { font-size: 32px; color: #0078d7; margin-bottom: 10px; }
        .settings-option-card span { font-size: 13px; color: #333; font-weight: 500; }
        .settings-nav-bar { padding: 10px 15px; background: #f0f0f0; border-bottom: 1px solid #dcdcdc; display: flex; align-items: center; }
        .settings-back-btn { cursor: pointer; color: #0078d7; font-size: 12px; display: flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 3px; border: 1px solid transparent; }
        .settings-back-btn:hover { background: #e0e0e0; border-color: #ccc; }

        /* --- THEMES (XP & Aero) --- */
        /* Estilo XP (Luna) */
        body.theme-xp { font-family: 'Tahoma', sans-serif; }
        body.theme-xp .window { border-radius: 5px 5px 0 0; border: 3px solid #0055ea; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); background: #ece9d8; }
        body.theme-xp .window-content { border: 1px solid #0055ea; background: #fff; }
        body.theme-xp .window-header { background: linear-gradient(to bottom, #0058ee 0%, #3593ff 4%, #288eec 6%, #127dff 8%, #0369fc 10%, #0a58c2 90%, #004a9e 100%); border-radius: 3px 3px 0 0; height: 30px; border-bottom: none; }
        body.theme-xp .window-title { text-shadow: 1px 1px #000; color: #fff; font-weight: bold; font-family: 'Tahoma', sans-serif; }
        
        body.theme-xp #taskbar { background: linear-gradient(to bottom, #245edb 0%, #3f76ea 10%, #295ec6 40%, #0d3a94 100%); border-top: none; backdrop-filter: none; box-shadow: none; height: 34px; padding-left: 0; z-index: 10001; }
        body.theme-xp #start-button { border-radius: 0 15px 15px 0; background: linear-gradient(to bottom, #388e3c 0%, #5fb04b 10%, #388e3c 50%, #2e7d32 100%); box-shadow: 2px 2px 2px rgba(0,0,0,0.3); width: auto; min-width: 100px; padding: 0 15px 0 5px; height: 34px; border: 2px solid #fff; border-left: none; margin-right: 10px; margin-left: 0; clip-path: none; }
        body.theme-xp #start-button:hover { filter: brightness(1.1); background: linear-gradient(to bottom, #4caf50 0%, #81c784 10%, #4caf50 50%, #388e3c 100%); }
        body.theme-xp #start-button i { font-style: italic; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); font-size: 18px; margin-right: 5px; }
        body.theme-xp #start-button::after { content: "iniciar"; font-style: italic; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); color: #fff; font-family: 'Tahoma', sans-serif; }

        body.theme-xp .task-item { background: linear-gradient(to bottom, #396ecc 0%, #396ecc 50%, #295ec6 100%); border: none; box-shadow: inset 1px 1px 0 rgba(255,255,255,0.3); border-radius: 3px; margin-top: 2px; height: 26px; color: white; font-family: 'Tahoma', sans-serif; }
        body.theme-xp .task-item.active { background: #1e4f9f; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5); }
        body.theme-xp #tray { background: linear-gradient(to right, #1290e6, #245edb); border-left: 1px solid #104a88; border-radius: 2px; padding: 0 10px; margin: 2px 5px 2px 0; height: 26px; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); color: #fff; text-shadow: none; }
        body.theme-xp #start-menu { background: #fff; border: 2px solid #315bb8; border-radius: 5px 5px 0 0; box-shadow: 4px 4px 10px rgba(0,0,0,0.6); backdrop-filter: none; width: 380px; height: auto; min-height: 450px; padding: 0; bottom: 34px; }
        
        .xp-start-header { display: none; }
        body.theme-xp .xp-start-header { display: flex; align-items: center; height: 60px; background: linear-gradient(to bottom, #1c72ea 0%, #154cbd 100%); border-bottom: 2px solid #e57e00; padding: 0 10px; border-radius: 3px 3px 0 0; margin-bottom: 2px; cursor: pointer; }
        body.theme-xp .xp-user-pic { width: 44px; height: 44px; background: #fff; border-radius: 4px; border: 2px solid #d3e5fa; display: flex; align-items: center; justify-content: center; margin-right: 10px; box-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        body.theme-xp .xp-user-pic i { color: #555; font-size: 24px; }
        body.theme-xp #xp-username { color: #fff; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        body.theme-xp .start-top { padding: 0; background: #fff; }
        .xp-spacer { display: none; }
        body.theme-xp .xp-spacer { display: block; flex-grow: 1; border-bottom: 1px solid #eee; margin-bottom: 5px; }
        body.theme-xp .start-left { background: #fff; border: none; width: 50%; padding: 10px; border-right: 1px solid #ccc; }
        body.theme-xp .start-right { background: #d3e5fa; width: 50%; border-left: 1px solid #9dbce8; padding: 10px; gap: 5px; }
        body.theme-xp .start-item { color: #333; font-family: 'Tahoma', sans-serif; border-radius: 2px; height: 36px; }
        body.theme-xp .start-item:hover { background: #316ac5; color: #fff; border: none; margin: 0; }
        body.theme-xp .start-item:hover i { color: #fff !important; }
        body.theme-xp .start-right-item { color: #001e4e; font-weight: bold; font-family: 'Tahoma', sans-serif; height: 30px; display: flex; align-items: center; }
        body.theme-xp .start-right-item:hover { background: #316ac5; color: #fff; box-shadow: none; }
        body.theme-xp #start-username-display { display: none; }
        body.theme-xp hr { border-color: #9dbce8; opacity: 1; }
        body.theme-xp .start-bottom { background: linear-gradient(to bottom, #1c72ea 0%, #154cbd 100%); height: 45px; border-radius: 0 0 3px 3px; border-top: 1px solid #fff; padding: 0 15px; justify-content: flex-end; }
        body.theme-xp .search-bar { display: none; }
        body.theme-xp .shutdown-btn { background: linear-gradient(to bottom, #e44d26, #b82800); border: 1px solid #800000; color: #fff; font-family: 'Tahoma', sans-serif; box-shadow: inset 1px 1px 1px rgba(255,255,255,0.4); display: flex; align-items: center; gap: 5px; }
        body.theme-xp .shutdown-btn::before { content: "\f011"; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        /* --- THEME WINDOWS 8 (Metro/Modern) --- */
        body.theme-win8 #taskbar { background: rgba(0, 0, 0, 0.75); border-top: none; backdrop-filter: blur(5px); height: 40px; }
        body.theme-win8 #start-button { border-radius: 0; background: transparent; box-shadow: none; width: 48px; margin-right: 5px; }
        body.theme-win8 #start-button:hover { background: rgba(255,255,255,0.1); }
        body.theme-win8 #start-button i { font-size: 22px; color: #fff; }
        body.theme-win8 .window { border-radius: 0; border: 1px solid var(--win8-accent); box-shadow: 0 0 10px rgba(0,0,0,0.2); background: #fff; }
        body.theme-win8 .window-header { background: var(--win8-accent); border-bottom: none; color: #fff; height: 32px; }
        body.theme-win8 .window-title { text-align: center; justify-content: center; width: 100%; text-shadow: none; font-family: "Segoe UI", sans-serif; font-weight: normal; }
        body.theme-win8 .window-title i { display: none; }
        body.theme-win8 .window-content { border: none; margin: 0; }
        body.theme-win8 .win-controls { gap: 0; margin-right: -12px; height: 100%; }
        body.theme-win8 .win-btn { border-radius: 0; border: none; background: transparent; color: #fff; box-shadow: none; width: 45px; height: 100%; font-size: 14px; }
        body.theme-win8 .win-btn:hover { background: rgba(255,255,255,0.2); }
        body.theme-win8 .win-close:hover { background: #e81123; }
        #start-screen-8 { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--win8-accent); background-image: var(--win8-bg-pattern); z-index: 9998; flex-direction: column; padding: 40px 80px; overflow-x: auto; animation: slideIn8 0.3s ease-out; }
        @keyframes slideIn8 { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        body.theme-win8 #start-menu { display: none !important; }
        .win8-header-user { display: flex; justify-content: flex-end; align-items: center; color: white; margin-bottom: 40px; font-size: 18px; gap: 15px; }
        .win8-user-img { width: 40px; height: 40px; background: #ccc; }
        .win8-grid-container { display: flex; flex-direction: column; gap: 10px; }
        .win8-group-title { font-size: 20px; color: rgba(255,255,255,0.8); margin-bottom: 5px; }
        .win8-tiles { display: grid; grid-template-columns: repeat(auto-fill, 120px); grid-auto-flow: column; grid-template-rows: repeat(3, 120px); gap: 10px; height: 400px; }
        .tile { width: 120px; height: 120px; background: #0078d7; padding: 10px; display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer; transition: transform 0.1s; position: relative; border: 2px solid transparent; }
        .tile:hover { border: 2px solid rgba(255,255,255,0.4); transform: scale(0.98); }
        .tile:active { transform: scale(0.95); }
        .tile i { font-size: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -60%); }
        .tile span { font-size: 13px; font-weight: 500; }
        .tile.wide { grid-column: span 2; width: 250px; background: #d9534f; }
        .tile.green { background: #27ae60; }
        .tile.purple { background: #8e44ad; }
        .tile.orange { background: #e67e22; }
        .tile.teal { background: #16a085; }
        .tile.blue { background: #2980b9; }
        .win8-back-btn { position: absolute; bottom: 20px; left: 20px; font-size: 24px; cursor: pointer; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 50%; }

        /* --- THEME WINDOWS 10 --- */
        body.theme-win10 #taskbar {
            background: var(--win10-taskbar);
            border-top: none;
            backdrop-filter: blur(10px);
            height: 40px;
            justify-content: flex-start;
            padding-left: 0;
        }
        body.theme-win10 #start-button {
            border-radius: 0;
            background: transparent;
            box-shadow: none;
            width: 48px;
            height: 40px;
            margin-right: 0;
        }
        body.theme-win10 #start-button:hover { background: rgba(255,255,255,0.1); }
        body.theme-win10 #start-button i { font-size: 20px; color: #fff; }
        
        body.theme-win10 #win10-search-bar {
            display: flex;
            align-items: center;
            background: #fff;
            height: 40px;
            width: 300px;
            padding: 0 10px;
            margin-right: 5px;
        }
        body.theme-win10 #win10-search-bar i { color: #555; margin-right: 10px; }
        body.theme-win10 #win10-search-bar input {
            border: none;
            outline: none;
            font-family: "Segoe UI", sans-serif;
            font-size: 13px;
            width: 100%;
        }

        body.theme-win10 .task-item {
            width: 46px; /* Icon width */
            height: 40px;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            justify-content: center;
            margin: 0;
            padding: 0;
        }
        body.theme-win10 .task-item:hover { background: rgba(255,255,255,0.1); }
        body.theme-win10 .task-item.active { background: rgba(255,255,255,0.15); border-bottom: 2px solid var(--win10-accent); box-shadow: none; }
        body.theme-win10 .task-item span { display: none; }
        body.theme-win10 .task-item i, body.theme-win10 .task-item img { margin: 0; font-size: 20px; }

        body.theme-win10 .window {
            border-radius: 0;
            border: 1px solid #1883d7; /* Standard Accent Border */
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            background: #fff;
        }
        body.theme-win10 .window-header {
            background: #fff;
            color: #000;
            height: 30px;
            border-bottom: none;
            text-shadow: none;
        }
        body.theme-win10 .window-title { justify-content: flex-start; margin-left: 5px; font-weight: normal; font-size: 12px; }
        body.theme-win10 .win-controls { gap: 0; margin-right: -13px; height: 100%; align-items: flex-start; }
        body.theme-win10 .win-btn {
            border-radius: 0;
            border: none;
            background: transparent;
            color: #000;
            box-shadow: none;
            width: 46px;
            height: 29px;
            font-size: 10px;
        }
        body.theme-win10 .win-btn:hover { background: #e5e5e5; }
        body.theme-win10 .win-close:hover { background: #e81123; color: white; }
        body.theme-win10 .window-content { border: none; margin: 0; border-top: 1px solid #ccc; }

        /* Win10 Start Menu */
        #start-menu-10 {
            display: none;
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 650px;
            height: 500px;
            background: var(--win10-bg);
            backdrop-filter: blur(15px);
            z-index: 10000;
            flex-direction: row;
            animation: slideUp10 0.15s ease-out;
            color: white;
        }
        @keyframes slideUp10 { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        body.theme-win10 #start-menu { display: none !important; }

        .s10-sidebar {
            width: 48px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 10px;
            align-items: center;
            gap: 5px;
        }
        .s10-side-btn { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; }
        .s10-side-btn:hover { background: rgba(255,255,255,0.1); }
        .s10-side-btn i { font-size: 16px; color: #fff; }

        .s10-list {
            width: 250px;
            padding: 10px 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.05);
        }
        .s10-list-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; font-size: 12px; cursor: pointer; }
        .s10-list-item:hover { background: rgba(255,255,255,0.1); }
        .s10-list-item img, .s10-list-item i { width: 20px; text-align: center; }

        .s10-tiles-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.05);
        }
        .s10-group-title { font-size: 12px; font-weight: 600; margin-bottom: 10px; margin-top: 10px; }
        .s10-grid { display: grid; grid-template-columns: repeat(3, 100px); gap: 4px; }
        .s10-tile {
            width: 100px;
            height: 100px;
            background: #0078d7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }
        .s10-tile:hover { border-color: rgba(255,255,255,0.4); }
        .s10-tile:active { transform: scale(0.98); }
        .s10-tile i { font-size: 32px; margin-bottom: 10px; }
        .s10-tile span { position: absolute; bottom: 5px; left: 8px; font-size: 11px; font-weight: 500; }
        .s10-tile.wide { grid-column: span 2; width: 204px; }
        .s10-tile.small { width: 48px; height: 48px; }


        /* --- THEME WINDOWS 11 - IMPROVED --- */
        
        /* Win11 Taskbar */
        body.theme-win11 #taskbar {
            background: rgba(255, 255, 255, 0.9); /* More opaque */
            backdrop-filter: blur(20px) saturate(1.2);
            border-top: 1px solid rgba(0,0,0,0.05);
            height: 48px;
            justify-content: center; /* Center Items */
            gap: 6px;
            padding-bottom: 0;
            padding-top: 0;
        }

        body.theme-win11 #start-button {
            width: 40px;
            height: 40px;
            border-radius: 4px; /* Slightly rounded square */
            background: transparent !important; /* Force transparent override */
            box-shadow: none !important;
            margin: 0;
            order: 0;
            transition: background 0.2s, transform 0.1s;
        }
        body.theme-win11 #start-button:hover { background: rgba(255, 255, 255, 0.5) !important; }
        body.theme-win11 #start-button:active { transform: scale(0.9); }
        body.theme-win11 #start-button i { 
            color: #0078d7; 
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        /* Search Icon Special for Win11 */
        body.theme-win11 #win11-search-icon {
            display: flex !important;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        body.theme-win11 #win11-search-icon:hover { background: rgba(255, 255, 255, 0.5); }
        body.theme-win11 #win11-search-icon i { color: #555; font-size: 20px; transform: scaleX(-1); }

        body.theme-win11 #task-container {
            flex-grow: 0;
            width: auto;
            justify-content: center;
            gap: 6px;
        }

        body.theme-win11 .task-item {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
            border: none;
            background: transparent;
            box-shadow: none;
            border-radius: 4px;
            position: relative;
            transition: all 0.2s;
        }
        body.theme-win11 .task-item:hover { background: rgba(255,255,255,0.5); }
        
        /* New Active Indicator (Pill) */
        body.theme-win11 .task-item.active { 
            background: rgba(255,255,255,0.4); 
            border: none; /* Reset old border */
        }
        body.theme-win11 .task-item.active::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 6px; /* Start small */
            height: 3px;
            background: #0078d7;
            border-radius: 2px;
            animation: expandPill 0.3s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes expandPill { to { width: 16px; } }

        body.theme-win11 .task-item span { display: none; } /* Hide text, icon only */
        body.theme-win11 .task-item i, body.theme-win11 .task-item img { margin: 0; font-size: 20px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); } to { transform: scale(1); } }

        body.theme-win11 #tray {
            position: absolute;
            right: 15px;
            height: 100%;
            border: none;
            color: #222; /* Dark text for light taskbar */
            text-shadow: none;
            font-weight: 500;
        }

        /* Win11 Windows */
        body.theme-win11 .window {
            border-radius: 8px; /* Rounded Corners */
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            background: rgba(255, 255, 255, 0.9);
        }
        body.theme-win11 .window-header {
            background: transparent;
            border-bottom: none;
            color: #000;
            height: 40px;
            text-shadow: none;
        }
        body.theme-win11 .window-title { justify-content: flex-start; margin-left: 5px; }
        body.theme-win11 .win-controls { gap: 0; margin-right: 0; }
        body.theme-win11 .win-btn { background: transparent; border: none; box-shadow: none; width: 46px; height: 32px; font-size: 12px; border-radius: 4px; }
        body.theme-win11 .win-btn:hover { background: rgba(0,0,0,0.05); }
        body.theme-win11 .win-close:hover { background: #c42b1c; color: white; border-radius: 0 8px 0 0; }
        body.theme-win11 .window-content { border: 1px solid rgba(0,0,0,0.05); border-radius: 0 0 8px 8px; background: #fff; margin: 0; }

        /* Win11 Start Menu */
        #start-menu-11 {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 650px;
            background: rgba(243, 243, 243, 0.85); /* Mica effect */
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            flex-direction: column;
            padding: 25px;
            animation: slideUp11 0.25s cubic-bezier(0,0,0.2,1);
        }

        @keyframes slideUp11 {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        body.theme-win11 #start-menu { display: none !important; }

        .s11-search {
            background: #fff;
            border: 1px solid #ddd;
            border-bottom: 2px solid #0078d7; /* Accent underline */
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .s11-search input { border: none; outline: none; width: 100%; font-size: 14px; color: #555; background: transparent; }
        
        .s11-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }
        .s11-btn-all { background: rgba(255,255,255,0.5); border: 1px solid transparent; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .s11-btn-all:hover { background: rgba(255,255,255,0.8); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .s11-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .s11-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 5px;
            border-radius: 4px;
            transition: background 0.1s;
        }
        .s11-item:hover { background: rgba(255,255,255,0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .s11-item i { font-size: 24px; color: #333; }
        .s11-item span { font-size: 11px; color: #333; text-align: center; }

        .s11-recommended {
            flex-grow: 1;
        }
        .s11-rec-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .s11-rec-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .s11-rec-item:hover { background: rgba(0,0,0,0.03); }
        .s11-rec-icon { font-size: 20px; color: #555; width: 30px; text-align: center; }
        .s11-rec-text { display: flex; flex-direction: column; }
        .s11-rec-name { font-size: 12px; font-weight: 600; color: #333; }
        .s11-rec-meta { font-size: 11px; color: #777; }

        .s11-footer {
            height: 50px;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin: 0 -25px -25px -25px;
            padding: 0 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.02);
            border-radius: 0 0 8px 8px;
        }
        .s11-user { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #333; font-weight: 600; cursor: pointer; padding: 5px; border-radius: 4px; }
        .s11-user:hover { background: rgba(0,0,0,0.05); }
        .s11-power { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; color: #333; }
        .s11-power:hover { background: rgba(0,0,0,0.05); }

    </style>
</head>
<body onclick="handleGlobalClick(event)">

    <div id="bsod" onclick="this.style.display='none'">
        <!-- Win 8 version (simplified) -->
        <div style="font-size:100px; margin-bottom:20px;">:(</div>
        <div style="font-size:24px; margin-bottom:20px;">Your PC ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</div>
        <div style="font-size:14px;">0% complete</div>
        <br><br>
        <!-- Classic Text (hidden via flex direction if win8) -->
        <p class="legacy-bsod">A problem has been detected and Windows has been shut down to prevent damage to your computer.</p>
        <p class="legacy-bsod">PAGE_FAULT_IN_NONPAGED_AREA</p>
        <p class="legacy-bsod" style="margin-top:20px;">(Clique para reiniciar...)</p>
    </div>

    <!-- Windows 8 Start Screen -->
    <div id="start-screen-8" onclick="event.stopPropagation()">
        <div class="win8-header-user">
            <span id="win8-username">Usuário</span>
            <div class="win8-user-img" style="display:flex; justify-content:center; align-items:center; border-radius:50%; overflow:hidden">
                <i class="fas fa-user"></i>
            </div>
            <i class="fas fa-power-off" style="cursor:pointer; margin-left:15px;" title="Desligar" onclick="location.reload()"></i>
        </div>

        <div class="win8-grid-container">
            <div class="win8-group-title">Início</div>
            <div class="win8-tiles">
                <div class="tile blue" onclick="wm.openWindow('computer'); toggleStartMenu()">
                    <i class="fas fa-desktop"></i>
                    <span>Desktop</span>
                </div>
                <div class="tile wide purple" onclick="wm.openWindow('browser'); toggleStartMenu()">
                    <i class="fab fa-internet-explorer"></i>
                    <span>Internet</span>
                </div>
                <div class="tile orange" onclick="wm.openWindow('explorer'); toggleStartMenu()">
                    <i class="fas fa-folder-open"></i>
                    <span>Ficheiros</span>
                </div>
                <div class="tile green" onclick="wm.openWindow('hub'); toggleStartMenu()">
                    <i class="fas fa-gamepad"></i>
                    <span>Jogos</span>
                </div>
                <div class="tile wide" style="background:linear-gradient(135deg, #f25022, #7fba00, #00a4ef, #ffb900)" onclick="wm.openWindow('store'); toggleStartMenu()">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Store</span>
                </div>
                <div class="tile teal" onclick="wm.openWindow('calc'); toggleStartMenu()">
                    <i class="fas fa-calculator"></i>
                    <span>Calc</span>
                </div>
                <div class="tile wide blue" onclick="wm.openWindow('paint'); toggleStartMenu()">
                    <i class="fas fa-paint-brush"></i>
                    <span>Paint Studio</span>
                </div>
                <div class="tile" style="background:#333" onclick="wm.openWindow('cmd'); toggleStartMenu()">
                    <i class="fas fa-terminal"></i>
                    <span>CMD</span>
                </div>
                <div class="tile orange" onclick="wm.openWindow('settings'); toggleStartMenu()">
                    <i class="fas fa-cog"></i>
                    <span>Definições</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Windows 10 Start Menu -->
    <div id="start-menu-10" onclick="event.stopPropagation()">
        <div class="s10-sidebar">
            <div style="flex-grow:1"></div>
            <div class="s10-side-btn" onclick="wm.openWindow('settings'); toggleStartMenu()"><i class="fas fa-cog"></i></div>
            <div class="s10-side-btn" onclick="wm.openWindow('computer'); toggleStartMenu()"><i class="fas fa-folder"></i></div>
            <div class="s10-side-btn" onclick="location.reload()"><i class="fas fa-power-off"></i></div>
        </div>
        <div class="s10-list">
            <div class="s10-list-item" onclick="wm.openWindow('calc'); toggleStartMenu()">
                <i class="fas fa-calculator"></i> Calculadora
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('cmd'); toggleStartMenu()">
                <i class="fas fa-terminal"></i> Linha de Comandos
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('explorer'); toggleStartMenu()">
                <i class="fas fa-folder"></i> Explorador de Ficheiros
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('hub'); toggleStartMenu()">
                <i class="fas fa-gamepad"></i> Gaming Hub
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('store'); toggleStartMenu()">
                <i class="fas fa-shopping-bag"></i> Microsoft Store
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('browser'); toggleStartMenu()">
                <i class="fab fa-internet-explorer"></i> Microsoft Edge
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('notepad'); toggleStartMenu()">
                <i class="fas fa-sticky-note"></i> Bloco de Notas
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('paint'); toggleStartMenu()">
                <i class="fas fa-paint-brush"></i> Paint
            </div>
            <div class="s10-list-item" onclick="wm.openWindow('settings'); toggleStartMenu()">
                <i class="fas fa-cog"></i> Definições
            </div>
        </div>
        <div class="s10-tiles-area">
            <div class="s10-group-title">Produtividade</div>
            <div class="s10-grid">
                <div class="s10-tile" onclick="wm.openWindow('browser'); toggleStartMenu()">
                    <i class="fab fa-internet-explorer"></i>
                    <span>Edge</span>
                </div>
                <div class="s10-tile" style="background:#2b88d8" onclick="wm.openWindow('notepad'); toggleStartMenu()">
                    <i class="fas fa-sticky-note"></i>
                    <span>Bloco de Notas</span>
                </div>
                <div class="s10-tile" style="background: linear-gradient(135deg, #f25022 0%, #7fba00 25%, #00a4ef 50%, #ffb900 75%)" onclick="wm.openWindow('store'); toggleStartMenu()">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Store</span>
                </div>
                <div class="s10-tile wide" style="background:#333; align-items:flex-start; padding-left:15px;" onclick="wm.openWindow('cmd'); toggleStartMenu()">
                    <i class="fas fa-terminal" style="font-size:20px; margin-bottom:5px"></i>
                    <span style="position:static; margin-bottom:5px">Terminal</span>
                    <span style="position:static; font-size:10px; opacity:0.7">C:\User\Admin</span>
                </div>
            </div>
            <div class="s10-group-title">Jogos & Diversão</div>
            <div class="s10-grid">
                <div class="s10-tile wide" style="background:#f1c40f" onclick="wm.openWindow('hub'); toggleStartMenu()">
                    <i class="fas fa-gamepad"></i>
                    <span>Gaming Hub</span>
                </div>
                <div class="s10-tile" style="background:#d83b01" onclick="wm.openWindow('paint'); toggleStartMenu()">
                    <i class="fas fa-paint-brush"></i>
                    <span>Paint 3D</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Windows 11 Start Menu -->
    <div id="start-menu-11" onclick="event.stopPropagation()">
        <div class="s11-search">
            <i class="fas fa-search" style="color:#666"></i>
            <input type="text" placeholder="Escreva aqui para procurar">
        </div>

        <div class="s11-section-title">
            <span>Afixado</span>
            <div class="s11-btn-all">Todas as aplicações ></div>
        </div>
        <div class="s11-grid">
            <div class="s11-item" onclick="wm.openWindow('browser'); toggleStartMenu()">
                <i class="fab fa-internet-explorer" style="color:#0078d7"></i> <span>Edge</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('store'); toggleStartMenu()">
                <i class="fas fa-shopping-bag" style="color:#00a4ef"></i> <span>Store</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('explorer'); toggleStartMenu()">
                <i class="fas fa-folder" style="color:#f39c12"></i> <span>Explorador</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('settings'); toggleStartMenu()">
                <i class="fas fa-cog" style="color:#777"></i> <span>Definições</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('hub'); toggleStartMenu()">
                <i class="fas fa-gamepad" style="color:#0078d7"></i> <span>Jogos</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('paint'); toggleStartMenu()">
                <i class="fas fa-paint-brush" style="color:#e74c3c"></i> <span>Paint</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('calc'); toggleStartMenu()">
                <i class="fas fa-calculator" style="color:#333"></i> <span>Calc</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('notepad'); toggleStartMenu()">
                <i class="fas fa-sticky-note" style="color:#0078d7"></i> <span>Notas</span>
            </div>
            <div class="s11-item" onclick="wm.openWindow('cmd'); toggleStartMenu()">
                <i class="fas fa-terminal" style="color:#333"></i> <span>Terminal</span>
            </div>
        </div>

        <div class="s11-section-title">
            <span>Recomendado</span>
            <div class="s11-btn-all">Mais ></div>
        </div>
        <div class="s11-recommended">
            <div class="s11-rec-item" onclick="wm.openWindow('notepad'); toggleStartMenu()">
                <div class="s11-rec-icon"><i class="fas fa-file-alt"></i></div>
                <div class="s11-rec-text">
                    <span class="s11-rec-name">Trabalho.txt</span>
                    <span class="s11-rec-meta">Há 10 min</span>
                </div>
            </div>
            <div class="s11-rec-item" onclick="wm.openWindow('hub'); toggleStartMenu()">
                <div class="s11-rec-icon"><i class="fas fa-gamepad" style="color:#e67e22"></i></div>
                <div class="s11-rec-text">
                    <span class="s11-rec-name">Snake</span>
                    <span class="s11-rec-meta">Ontem às 14:00</span>
                </div>
            </div>
        </div>

        <div class="s11-footer">
            <div class="s11-user" onclick="wm.openWindow('settings'); wm.navSettings('user'); toggleStartMenu()">
                <div style="width:24px; height:24px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center"><i class="fas fa-user" style="font-size:12px; color:#555"></i></div>
                <span id="win11-username">Usuário</span>
            </div>
            <div class="s11-power" onclick="location.reload()">
                <i class="fas fa-power-off"></i>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu -->
    <div id="context-menu" onclick="event.stopPropagation()">
        <div class="ctx-item">
            <div class="ctx-icon"></div>
            <span>Ver</span>
            <div class="ctx-arrow">▶</div>
            <div class="ctx-submenu">
                <div class="ctx-item" onclick="wm.resizeIcons('large'); wm.closeContext()">
                    <div class="ctx-icon" id="check-large"></div>
                    <span>Ícones grandes</span>
                </div>
                <div class="ctx-item" onclick="wm.resizeIcons('medium'); wm.closeContext()">
                    <div class="ctx-icon" id="check-medium">●</div>
                    <span>Ícones médios</span>
                </div>
                <div class="ctx-item" onclick="wm.resizeIcons('small'); wm.closeContext()">
                    <div class="ctx-icon" id="check-small"></div>
                    <span>Ícones pequenos</span>
                </div>
                <div class="ctx-separator"></div>
                <div class="ctx-item" onclick="wm.toggleIcons(); wm.closeContext()">
                    <div class="ctx-icon" id="check-visible">✓</div>
                    <span>Mostrar ícones do ambiente de trabalho</span>
                </div>
            </div>
        </div>
        <div class="ctx-item">
            <div class="ctx-icon"></div>
            <span>Ordenar por</span>
            <div class="ctx-arrow">▶</div>
            <div class="ctx-submenu">
                <div class="ctx-item" onclick="wm.closeContext()"><span>Nome</span></div>
                <div class="ctx-item" onclick="wm.closeContext()"><span>Tamanho</span></div>
                <div class="ctx-item" onclick="wm.closeContext()"><span>Tipo de item</span></div>
                <div class="ctx-item" onclick="wm.closeContext()"><span>Data de modificação</span></div>
            </div>
        </div>
        <div class="ctx-item" onclick="location.reload()">
            <div class="ctx-icon"></div>
            <span>Atualizar</span>
        </div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" style="color: #888">
            <div class="ctx-icon"></div>
            <span>Colar</span>
        </div>
        <div class="ctx-item" style="color: #888">
            <div class="ctx-icon"></div>
            <span>Colar atalho</span>
        </div>
        <div class="ctx-separator"></div>
        <div class="ctx-item">
            <div class="ctx-icon"></div>
            <span>Novo</span>
            <div class="ctx-arrow">▶</div>
            <div class="ctx-submenu">
                <div class="ctx-item" onclick="wm.closeContext()">
                    <div class="ctx-icon"><i class="fas fa-folder" style="color:#f39c12"></i></div>
                    <span>Pasta</span>
                </div>
                <div class="ctx-item" onclick="wm.closeContext()">
                    <div class="ctx-icon"><i class="fas fa-share" style="color:#333"></i></div>
                    <span>Atalho</span>
                </div>
                <div class="ctx-separator"></div>
                <div class="ctx-item" onclick="wm.openWindow('notepad'); wm.closeContext()">
                    <div class="ctx-icon"><i class="fas fa-file-alt" style="color:#aaa"></i></div>
                    <span>Documento de Texto</span>
                </div>
            </div>
        </div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" onclick="alert('Resolução: 1920x1080 (Simulado)'); wm.closeContext()">
            <div class="ctx-icon"><i class="fas fa-desktop"></i></div>
            <span>Resolução de ecrã</span>
        </div>
        <div class="ctx-item" onclick="alert('Não há gadgets instalados.'); wm.closeContext()">
            <div class="ctx-icon"><i class="fas fa-puzzle-piece"></i></div>
            <span>Gadgets</span>
        </div>
        <div class="ctx-item" onclick="wm.openWindow('settings'); wm.navSettings('theme'); wm.closeContext()">
            <div class="ctx-icon"><i class="fas fa-paint-brush"></i></div>
            <span>Personalizar</span>
        </div>
    </div>

    <div id="desktop" onmousedown="handleDesktopMouseDown(event)">
        <!-- Retângulo de Seleção -->
        <div id="selection-box"></div>

        <!-- Desktop Icons -->
        <div class="desktop-icon" style="top: 10px; left: 10px;" onclick="wm.openWindow('computer')">
            <i class="fas fa-desktop icon-computer"></i>
            <span>Computador</span>
        </div>
        <div class="desktop-icon" style="top: 110px; left: 10px;" onclick="wm.openWindow('browser')">
            <i class="fab fa-internet-explorer icon-ie"></i>
            <span>Internet</span>
        </div>
        <div class="desktop-icon" style="top: 210px; left: 10px;" onclick="wm.openWindow('explorer')">
            <i class="fas fa-folder icon-docs"></i>
            <span>Ficheiros</span>
        </div>
        <div class="desktop-icon" style="top: 310px; left: 10px;" onclick="wm.openWindow('store')">
            <i class="fas fa-shopping-bag icon-store"></i>
            <span>Microsoft Store</span>
        </div>
        
        <div class="desktop-icon" style="top: 10px; left: 100px;" onclick="wm.openWindow('hub')">
            <i class="fas fa-gamepad icon-hub"></i>
            <span>Gaming Hub</span>
        </div>
        <div class="desktop-icon" style="top: 110px; left: 100px;" onclick="wm.openWindow('calc')">
            <i class="fas fa-calculator icon-calc"></i>
            <span>Calculadora</span>
        </div>
        <div class="desktop-icon" style="top: 210px; left: 100px;" onclick="wm.openWindow('paint')">
            <i class="fas fa-paint-brush icon-paint"></i>
            <span>Paint</span>
        </div>
        <div class="desktop-icon" style="top: 310px; left: 100px;" onclick="wm.openWindow('cmd')">
            <i class="fas fa-terminal icon-cmd"></i>
            <span>CMD</span>
        </div>
        
        <div class="desktop-icon" style="top: 410px; left: 10px;" onclick="wm.triggerBSOD()">
            <i class="fas fa-exclamation-triangle icon-danger"></i>
            <span>NÃO CLIQUE</span>
        </div>
    </div>

    <!-- Start Menu (Classic/7) -->
    <div id="start-menu" onclick="event.stopPropagation()">
        <!-- Cabeçalho XP (Só aparece no tema XP) -->
        <div class="xp-start-header" onclick="wm.openWindow('settings'); wm.navSettings('user')">
            <div class="xp-user-pic"><i class="fas fa-chess-knight"></i></div>
            <span id="xp-username">Usuário</span>
        </div>

        <div class="start-top">
            <div class="start-left">
                <div class="start-item" onclick="wm.openWindow('browser'); toggleStartMenu()">
                    <i class="fab fa-internet-explorer" style="color: #0078d7"></i> Internet Explorer
                </div>
                <div class="start-item" onclick="wm.openWindow('store'); toggleStartMenu()">
                    <i class="fas fa-shopping-bag" style="color: #00a4ef"></i> Microsoft Store
                </div>
                <div class="start-item" onclick="wm.openWindow('paint'); toggleStartMenu()">
                    <i class="fas fa-paint-brush" style="color: #e74c3c"></i> Paint
                </div>
                <div class="start-item" onclick="wm.openWindow('cmd'); toggleStartMenu()">
                    <i class="fas fa-terminal" style="color: #333"></i> Linha de Comandos
                </div>
                <div class="start-item" onclick="wm.openWindow('hub'); toggleStartMenu()">
                    <i class="fas fa-gamepad" style="color: #f1c40f"></i> Gaming Hub
                </div>
                <div class="start-item" onclick="wm.openWindow('settings'); toggleStartMenu()">
                    <i class="fas fa-cog" style="color: #555"></i> Definições
                </div>
                <div class="start-item" onclick="wm.openWindow('calc'); toggleStartMenu()">
                    <i class="fas fa-calculator" style="color: #7f8c8d"></i> Calculadora
                </div>
                <div class="start-item" onclick="wm.openWindow('notepad'); toggleStartMenu()">
                    <i class="fas fa-sticky-note" style="color: #3498db"></i> Bloco de Notas
                </div>
                <div class="start-item" onclick="wm.openWindow('explorer'); toggleStartMenu()">
                    <i class="fas fa-folder-open" style="color: #f39c12"></i> Explorador
                </div>
                <!-- Spacer agora com classe para aparecer SÓ no XP -->
                <div class="xp-spacer"></div>
                
                <div class="start-item" onclick="toggleStartMenu()">
                    <div style="width:26px; text-align:center; font-weight:bold; color:#333">All</div> Todos os Programas
                </div>
            </div>
            <div class="start-right">
                <!-- Username removed here via CSS in XP mode -->
                <div class="start-right-item" id="start-username-display" style="font-weight: bold; margin-bottom: 5px; display:flex; align-items:center; gap:5px">
                    <i class="fas fa-user-circle"></i> <span>Usuário</span>
                </div>
                
                <div class="start-right-item" onclick="wm.openWindow('explorer'); toggleStartMenu()">
                    <i class="fas fa-folder" style="width:20px; color:#555"></i> Meus Documentos
                </div>
                <div class="start-right-item">
                    <i class="fas fa-images" style="width:20px; color:#555"></i> Minhas Imagens
                </div>
                <div class="start-right-item">
                    <i class="fas fa-music" style="width:20px; color:#555"></i> Minhas Músicas
                </div>
                
                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); width: 100%;">
                
                <div class="start-right-item" onclick="wm.openWindow('computer'); toggleStartMenu()">
                    <i class="fas fa-desktop" style="width:20px; color:#555"></i> Meu Computador
                </div>
                <div class="start-right-item" onclick="wm.openWindow('settings'); toggleStartMenu()">
                    <i class="fas fa-sliders-h" style="width:20px; color:#555"></i> Painel de Controlo
                </div>
                <div class="start-right-item" onclick="wm.openWindow('run'); toggleStartMenu()">
                    <i class="fas fa-keyboard" style="width:20px; color:#555"></i> Executar...
                </div>
            </div>
        </div>
        <div class="start-bottom">
            <div class="search-bar">
                <i class="fas fa-search" style="color: #aaa; font-size: 10px; margin-right: 5px;"></i>
                <input type="text" placeholder="Procurar programas e ficheiros" id="start-search">
            </div>
            <!-- Logoff Btn (only useful for XP style usually, but lets keep it simple) -->
            <div class="shutdown-btn" style="background:#f1c40f; border-color:#d35400; margin-right:10px; display:none;" id="xp-logoff">Log Off</div>
            <div class="shutdown-btn" onclick="location.reload()">Desligar</div>
        </div>
    </div>

    <div id="taskbar">
        <div id="start-button" onclick="toggleStartMenu(event)">
            <i class="fab fa-windows"></i>
        </div>
        <div id="win10-search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Escreva aqui para procurar">
        </div>
        <div id="win11-search-icon" onclick="toggleStartMenu()">
            <i class="fas fa-search"></i>
        </div>
        <div id="task-container"></div>
        <div id="tray">
            <div id="clock-time">00:00</div>
            <div id="clock-date">05/02/2026</div>
        </div>
    </div>

    <script>
        // --- Utils ---
        function handleGlobalClick(e) {
            const menu = document.getElementById('start-menu');
            const menu8 = document.getElementById('start-screen-8');
            const menu10 = document.getElementById('start-menu-10');
            const menu11 = document.getElementById('start-menu-11');
            const ctxMenu = document.getElementById('context-menu');
            const isWin8 = document.body.classList.contains('theme-win8');
            const isWin10 = document.body.classList.contains('theme-win10');
            const isWin11 = document.body.classList.contains('theme-win11');
            
            // Context Menu
            if (ctxMenu.style.display === 'block') {
                ctxMenu.style.display = 'none';
            }

            // Start Menu Logic
            if (isWin8) {
                if (menu8.style.display === 'flex' && !e.target.closest('#start-button')) {
                    // Start screen usually stays open until tile clicked
                }
            } else if (isWin10) {
                if (menu10.style.display === 'flex' && !e.target.closest('#start-menu-10') && !e.target.closest('#start-button')) {
                    menu10.style.display = 'none';
                }
            } else if (isWin11) {
                // Modified to ignore search icon too
                if (menu11.style.display === 'flex' && !e.target.closest('#start-menu-11') && !e.target.closest('#start-button') && !e.target.closest('#win11-search-icon')) {
                    menu11.style.display = 'none';
                }
            } else {
                if (menu.style.display === 'flex' && !e.target.closest('#start-menu') && !e.target.closest('#start-button')) {
                    menu.style.display = 'none';
                }
            }
        }

        // --- Context Menu Logic ---
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const ctxMenu = document.getElementById('context-menu');
            const menuWidth = ctxMenu.offsetWidth;
            const menuHeight = ctxMenu.offsetHeight;
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;
            
            let posX = e.clientX;
            let posY = e.clientY;

            // Simple collision detection
            if (posX + menuWidth > winWidth) posX = winWidth - menuWidth;
            if (posY + menuHeight > winHeight) posY = winHeight - menuHeight;

            ctxMenu.style.left = posX + "px";
            ctxMenu.style.top = posY + "px";
            ctxMenu.style.display = "block";
            
            // Hide start menus
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('start-menu-10').style.display = 'none';
            document.getElementById('start-menu-11').style.display = 'none';
        });

        // --- Marquise Logic ---
        let isSelecting = false;
        let startX, startY;
        const selectionBox = document.getElementById('selection-box');
        const desktopIcons = document.querySelectorAll('.desktop-icon');

        function handleDesktopMouseDown(e) {
            if (e.target.closest('.window') || e.target.closest('.desktop-icon')) return;

            // Only left click for selection
            if (e.button !== 0) return;

            isSelecting = true;
            startX = e.clientX;
            startY = e.clientY;

            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';

            if (!e.ctrlKey) {
                desktopIcons.forEach(icon => icon.classList.remove('selected'));
            }

            document.addEventListener('mousemove', handleDesktopMouseMove);
            document.addEventListener('mouseup', handleDesktopMouseUp);
        }

        function handleDesktopMouseMove(e) {
            if (!isSelecting) return;
            const currentX = e.clientX;
            const currentY = e.clientY;
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const left = Math.min(currentX, startX);
            const top = Math.min(currentY, startY);

            selectionBox.style.width = `${width}px`;
            selectionBox.style.height = `${height}px`;
            selectionBox.style.left = `${left}px`;
            selectionBox.style.top = `${top}px`;

            const selRect = selectionBox.getBoundingClientRect();

            desktopIcons.forEach(icon => {
                const iconRect = icon.getBoundingClientRect();
                const isOverlapping = !(
                    selRect.right < iconRect.left || 
                    selRect.left > iconRect.right || 
                    selRect.bottom < iconRect.top || 
                    selRect.top > iconRect.bottom
                );
                if (isOverlapping) icon.classList.add('selected');
                else if (!e.ctrlKey) icon.classList.remove('selected');
            });
        }

        function handleDesktopMouseUp() {
            isSelecting = false;
            selectionBox.style.display = 'none';
            document.removeEventListener('mousemove', handleDesktopMouseMove);
            document.removeEventListener('mouseup', handleDesktopMouseUp);
        }

        // --- Clock ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').innerText = now.toLocaleDateString('pt-PT');
        }
        setInterval(updateClock, 1000);
        updateClock();

        function toggleStartMenu(e) {
            if (e && e.stopPropagation) e.stopPropagation();
            
            const isWin8 = document.body.classList.contains('theme-win8');
            const isWin10 = document.body.classList.contains('theme-win10');
            const isWin11 = document.body.classList.contains('theme-win11');
            
            if (isWin8) {
                const menu8 = document.getElementById('start-screen-8');
                menu8.style.display = (menu8.style.display === 'flex') ? 'none' : 'flex';
                document.getElementById('start-menu').style.display = 'none';
                document.getElementById('start-menu-10').style.display = 'none';
                document.getElementById('start-menu-11').style.display = 'none';
            } else if (isWin10) {
                const menu10 = document.getElementById('start-menu-10');
                menu10.style.display = (menu10.style.display === 'flex') ? 'none' : 'flex';
                document.getElementById('start-menu').style.display = 'none';
                document.getElementById('start-screen-8').style.display = 'none';
                document.getElementById('start-menu-11').style.display = 'none';
            } else if (isWin11) {
                const menu11 = document.getElementById('start-menu-11');
                menu11.style.display = (menu11.style.display === 'flex') ? 'none' : 'flex';
                document.getElementById('start-menu').style.display = 'none';
                document.getElementById('start-menu-10').style.display = 'none';
                document.getElementById('start-screen-8').style.display = 'none';
            } else {
                const menu = document.getElementById('start-menu');
                document.getElementById('context-menu').style.display = 'none';
                menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
                document.getElementById('start-screen-8').style.display = 'none';
                document.getElementById('start-menu-10').style.display = 'none';
                document.getElementById('start-menu-11').style.display = 'none';
            }
        }

        // --- Window Manager ---
        class WindowManager {
            constructor() {
                this.windows = {};
                this.zIndex = 100;
                this.calcMemory = "";
                this.runImgUrl = "https://www.tenforums.com/geek/gars/images/2/types/thumb__un.png";
                
                // Icon state
                this.iconsVisible = true;
                this.iconSize = 'medium';

                this.settingsPages = {
                    menu: `
                        <div class="settings-content" style="height:100%; display:flex; flex-direction:column;">
                            <div style="padding:20px 20px 0 20px; font-size:16px; color:#003399;">Ajustar definições do computador</div>
                            <div class="settings-menu-grid">
                                <div class="settings-option-card" onclick="wm.navSettings('bg')">
                                    <i class="fas fa-image"></i>
                                    <span>Fundo do Ambiente de Trabalho</span>
                                </div>
                                <div class="settings-option-card" onclick="wm.navSettings('theme')">
                                    <i class="fas fa-palette"></i>
                                    <span>Cor e Aparência</span>
                                </div>
                                <div class="settings-option-card" onclick="wm.navSettings('user')">
                                    <i class="fas fa-user-circle"></i>
                                    <span>Conta de Utilizador</span>
                                </div>
                                <div class="settings-option-card" onclick="wm.navSettings('winver')">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Sobre o Sistema</span>
                                </div>
                            </div>
                        </div>
                    `,
                    bg: `
                        <div style="height:100%; display:flex; flex-direction:column; background:#fff;">
                            <div class="settings-nav-bar">
                                <div class="settings-back-btn" onclick="wm.navSettings('menu')"><i class="fas fa-arrow-left"></i> Painel de Controlo</div>
                            </div>
                            <div class="settings-content">
                                <div class="settings-section">
                                    <div class="settings-h2">Plano de Fundo do Ambiente de Trabalho</div>
                                    <p style="margin-bottom:10px; font-size:12px">Escolha um dos fundos padrão ou carregue uma imagem.</p>
                                    <div class="bg-preview-grid">
                                        <div class="bg-thumb" onclick="wm.setBg('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-4.0.3&w=1920')" style="background-image:url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-4.0.3&w=200')"></div>
                                        <div class="bg-thumb" onclick="wm.setBg('https://images.unsplash.com/photo-1477346611705-65d1883cee1e?ixlib=rb-4.0.3&w=1920')" style="background-image:url('https://images.unsplash.com/photo-1477346611705-65d1883cee1e?ixlib=rb-4.0.3&w=200')"></div>
                                        <div class="bg-thumb" onclick="wm.setBg('https://images.unsplash.com/photo-1451187580459-43490279c0fa?ixlib=rb-4.0.3&w=1920')" style="background-image:url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?ixlib=rb-4.0.3&w=200')"></div>
                                        <div class="bg-thumb" onclick="wm.setBg('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&w=1920')" style="background-image:url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&w=200')"></div>
                                    </div>
                                    <div class="upload-btn-wrapper">
                                        <button class="upload-btn"><i class="fas fa-upload" style="margin-right:5px"></i> Upar Foto do PC</button>
                                        <input type="file" accept="image/*" onchange="wm.handleBgUpload(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    theme: `
                        <div style="height:100%; display:flex; flex-direction:column; background:#fff;">
                            <div class="settings-nav-bar">
                                <div class="settings-back-btn" onclick="wm.navSettings('menu')"><i class="fas fa-arrow-left"></i> Painel de Controlo</div>
                            </div>
                            <div class="settings-content">
                                <div class="settings-section">
                                    <div class="settings-h2">Temas do Windows</div>
                                    <p style="margin-bottom:15px; font-size:12px">Escolha o estilo visual do sistema.</p>
                                    <div style="display:flex; gap:20px; flex-wrap:wrap">
                                        <div onclick="wm.setTheme('win11')" style="text-align:center; cursor:pointer;">
                                            <div style="width:120px; height:80px; background:linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); border-radius:8px; margin-bottom:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:2px solid #fff; display:flex; align-items:end; justify-content:center; padding-bottom:5px;">
                                                <div style="width:8px; height:8px; background:#0078d7; margin:0 2px;"></div>
                                                <div style="width:8px; height:8px; background:#0078d7; margin:0 2px;"></div>
                                                <div style="width:8px; height:8px; background:#0078d7; margin:0 2px;"></div>
                                            </div>
                                            <span style="font-weight:bold; color:#0055ea;">Windows 11</span>
                                        </div>
                                        <div onclick="wm.setTheme('win10')" style="text-align:center; cursor:pointer;">
                                            <div style="width:120px; height:80px; background:url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&w=200'); background-size:cover; border-radius:0; margin-bottom:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:2px solid #fff; position:relative;">
                                                <div style="position:absolute; bottom:0; left:0; width:100%; height:10px; background:rgba(0,0,0,0.8);"></div>
                                                <div style="position:absolute; bottom:0; left:0; width:12px; height:10px; background:white; display:flex; align-items:center; justify-content:center;"><i class="fab fa-windows" style="color:#333; font-size:8px"></i></div>
                                            </div>
                                            <span style="font-weight:bold; color:#333;">Windows 10</span>
                                        </div>
                                        <div onclick="wm.setTheme('win8')" style="text-align:center; cursor:pointer;">
                                            <div style="width:120px; height:80px; background:#4b2c89; border-radius:0; margin-bottom:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:2px solid #fff; display:flex; align-items:center; justify-content:center;">
                                                <div style="color:white; font-size:30px;"><i class="fab fa-windows"></i></div>
                                            </div>
                                            <span style="font-weight:bold; color:#4b2c89;">Windows 8 (Metro)</span>
                                        </div>
                                        <div onclick="wm.setTheme('aero')" style="text-align:center; cursor:pointer;">
                                            <div style="width:120px; height:80px; background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius:5px; margin-bottom:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:2px solid #fff;"></div>
                                            <span style="font-weight:bold; color:#0078d7;">Windows 7 (Aero)</span>
                                        </div>
                                        <div onclick="wm.setTheme('luna')" style="text-align:center; cursor:pointer;">
                                            <div style="width:120px; height:80px; background:linear-gradient(to bottom, #0058ee 0%, #004a9e 100%); border-radius:5px; margin-bottom:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:2px solid #fff; position:relative;">
                                                <div style="position:absolute; bottom:0; width:100%; height:15px; background:#245edb; border-radius:0 0 5px 5px;"></div>
                                                <div style="position:absolute; bottom:2px; left:2px; width:20px; height:10px; background:#388e3c; border-radius:0 5px 5px 0;"></div>
                                            </div>
                                            <span style="font-weight:bold; color:#0055ea;">Windows XP (Luna)</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="settings-section">
                                    <div class="settings-h2">Modo de Aplicação (Win 10/11)</div>
                                    <p style="margin-bottom:10px; font-size:12px">Escolha entre o modo claro e escuro para as janelas e menus.</p>
                                    <div style="display:flex; gap:15px; margin-top:10px;">
                                        <button class="upload-btn" onclick="wm.setDarkMode(false)">☀️ Claro</button>
                                        <button class="upload-btn" onclick="wm.setDarkMode(true)">🌙 Escuro</button>
                                    </div>
                                </div>

                                <div class="settings-section">
                                    <div class="settings-h2">Cor de Destaque (Windows 8)</div>
                                    <p style="margin-bottom:10px; font-size:12px">Escolha a cor principal para o ecrã Iniciar e janelas (apenas tema Win 8).</p>
                                    <div style="display:flex; gap:15px; margin-top:10px;">
                                        <div class="color-swatch" style="background:#4b2c89" onclick="wm.setWin8Color('#4b2c89')"></div>
                                        <div class="color-swatch" style="background:#0078d7" onclick="wm.setWin8Color('#0078d7')"></div>
                                        <div class="color-swatch" style="background:#e67e22" onclick="wm.setWin8Color('#e67e22')"></div>
                                        <div class="color-swatch" style="background:#c0392b" onclick="wm.setWin8Color('#c0392b')"></div>
                                        <div class="color-swatch" style="background:#27ae60" onclick="wm.setWin8Color('#27ae60')"></div>
                                        <div class="color-swatch" style="background:#2c3e50" onclick="wm.setWin8Color('#2c3e50')"></div>
                                    </div>
                                </div>

                                <div class="settings-section">
                                    <div class="settings-h2">Cor e Aparência (Aero)</div>
                                    <p style="margin-bottom:10px; font-size:12px">Selecione uma cor para o vidro das janelas (apenas tema Win 7).</p>
                                    <div style="display:flex; gap:15px; margin-top:10px;">
                                        <div class="color-swatch" style="background:rgba(20, 30, 50, 0.8)" title="Padrão" onclick="wm.setTheme('default')"></div>
                                        <div class="color-swatch" style="background:#0078d7" title="Azul" onclick="wm.setTheme('blue')"></div>
                                        <div class="color-swatch" style="background:#e67e22" title="Laranja" onclick="wm.setTheme('orange')"></div>
                                        <div class="color-swatch" style="background:#c0392b" title="Vermelho" onclick="wm.setTheme('red')"></div>
                                        <div class="color-swatch" style="background:#27ae60" title="Verde" onclick="wm.setTheme('green')"></div>
                                        <div class="color-swatch" style="background:#4b2c89" title="Roxo" onclick="wm.setTheme('purple')"></div>
                                        <div class="color-swatch" style="background:#2c3e50" title="Escuro" onclick="wm.setTheme('dark')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    user: `
                        <div style="height:100%; display:flex; flex-direction:column; background:#fff;">
                            <div class="settings-nav-bar">
                                <div class="settings-back-btn" onclick="wm.navSettings('menu')"><i class="fas fa-arrow-left"></i> Painel de Controlo</div>
                            </div>
                            <div class="settings-content">
                                <div class="settings-section">
                                    <div class="settings-h2">Conta de Utilizador</div>
                                    <div style="margin-top:10px;">
                                        <label style="font-size:12px; display:block; margin-bottom:5px;">Nome a apresentar no Menu Iniciar:</label>
                                        <div style="display:flex; gap:10px;">
                                            <input type="text" id="username-input" class="run-field" value="Usuário" style="width:200px; padding:5px;">
                                            <button class="upload-btn" onclick="wm.updateUsername()">Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    winver: `
                        <div style="height:100%; display:flex; flex-direction:column; background:#fff;">
                            <div class="settings-nav-bar">
                                <div class="settings-back-btn" onclick="wm.navSettings('menu')"><i class="fas fa-arrow-left"></i> Painel de Controlo</div>
                            </div>
                            <div class="settings-content">
                                <div class="winver-content">
                                    <div class="winver-logo"><i class="fab fa-windows"></i> <span style="font-size:30px; font-weight:bold; color:#000">Windows</span></div>
                                    <hr style="margin:10px 0">
                                    <p><strong>Microsoft Windows</strong><br>Ultimate Web Edition</p>
                                    <p>Copyright © Microsoft Corporation. Todos os direitos reservados.</p>
                                </div>
                            </div>
                        </div>
                    `
                };

                this.appConfigs = {
                    'notepad': { title: 'Bloco de Notas', icon: 'fa-sticky-note', w: 450, h: 350, content: '<textarea class="notepad-area"></textarea>' },
                    'browser': { 
                        title: 'Internet Explorer', 
                        icon: 'fa-globe', 
                        w: 900, 
                        h: 600, 
                        content: `
                            <div class="browser-toolbar">
                                <div class="win-btn" onclick="wm.goBack(event)"><i class="fas fa-arrow-left"></i></div>
                                <div class="win-btn" onclick="wm.reloadIframe(event)"><i class="fas fa-sync"></i></div>
                                <div class="browser-address">https://www.google.com</div>
                            </div>
                            <div style="height: calc(100% - 40px)">
                                <iframe src="https://www.google.com/search?igu=1" style="width:100%; height:100%; border:none;"></iframe>
                            </div>
                        `
                    },
                    'chrome': {
                        title: 'Google Chrome',
                        icon: 'fab fa-chrome',
                        w: 900,
                        h: 600,
                        content: `
                            <div class="browser-toolbar" style="background:#dfe1e5; padding-top:10px; border-bottom:1px solid #ccc; height:auto;">
                                <div style="width:100%; display:flex; flex-direction:column;">
                                    <div style="display:flex; width:200px; background:#fff; padding:6px 15px; border-radius: 8px 8px 0 0; margin-left:10px; font-size:12px; align-items:center;">
                                        <i class="fab fa-chrome" style="margin-right:8px; color:#5f6368"></i> Novo Separador
                                    </div>
                                    <div style="display:flex; align-items:center; background:#fff; padding:5px 10px; border-radius:20px; margin:5px 10px 10px 10px; border:1px solid #ccc; height:32px;">
                                        <i class="fas fa-lock" style="color:#5f6368; font-size:12px; margin-right:10px;"></i>
                                        <input type="text" value="https://www.google.com" style="border:none; outline:none; font-size:12px; flex-grow:1; color:#333;">
                                    </div>
                                </div>
                            </div>
                            <div style="height: calc(100% - 78px)">
                                <iframe src="https://www.google.com/search?igu=1" style="width:100%; height:100%; border:none;"></iframe>
                            </div>
                        `
                    },
                    'firefox': {
                        title: 'Mozilla Firefox',
                        icon: 'fab fa-firefox-browser',
                        w: 900,
                        h: 600,
                        content: `
                            <div class="browser-toolbar" style="background:#f0f0f4; border-bottom:1px solid #ccc; height:80px; display:block; padding:0;">
                                <div style="background:#0c0c0d; color:white; height:40px; display:flex; align-items:end; padding-left:10px;">
                                    <div style="background:#38383d; color:white; padding:8px 15px; border-radius: 4px 4px 0 0; font-size:12px;">Mozilla Firefox Start Page</div>
                                </div>
                                <div style="height:40px; display:flex; align-items:center; padding:0 10px; gap:10px;">
                                    <i class="fas fa-arrow-left" style="color:#555"></i>
                                    <i class="fas fa-redo" style="color:#555"></i>
                                    <div style="flex-grow:1; background:#fff; border:1px solid #ccc; border-radius:2px; height:28px; display:flex; align-items:center; padding-left:10px; font-size:12px;">https://www.google.com</div>
                                </div>
                            </div>
                            <div style="height: calc(100% - 80px)">
                                <iframe src="https://www.google.com/search?igu=1" style="width:100%; height:100%; border:none;"></iframe>
                            </div>
                        `
                    },
                    'store': {
                        title: 'Microsoft Store',
                        icon: 'fa-shopping-bag',
                        w: 800,
                        h: 600,
                        content: `
                            <div class="store-container">
                                <div class="store-header">
                                    <h2>Microsoft Store</h2>
                                    <div class="store-nav">
                                        <span class="active">Página Inicial</span>
                                        <span>Aplicações</span>
                                        <span>Jogos</span>
                                    </div>
                                    <div style="margin-left:auto; display:flex; gap:15px; font-size:14px;">
                                        <i class="fas fa-search"></i>
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                </div>
                                <div class="store-content">
                                    <div class="store-section-title">Navegadores Essenciais</div>
                                    <div class="store-grid">
                                        
                                        <!-- Internet Explorer -->
                                        <div class="store-card">
                                            <div class="store-icon-box" style="background:#eef7ff">
                                                <i class="fab fa-internet-explorer" style="font-size:40px; color:#1E90FF"></i>
                                            </div>
                                            <h3>Internet Explorer</h3>
                                            <p>Microsoft Corporation</p>
                                            <div style="color:#666; font-size:11px; margin-bottom:10px;">Navegador Web Clássico</div>
                                            <button class="store-btn" disabled>Instalado</button>
                                        </div>

                                        <!-- Chrome -->
                                        <div class="store-card">
                                            <div class="store-icon-box" style="background:#fff; border:1px solid #eee">
                                                <i class="fab fa-chrome" style="font-size:40px; color:#ea4335"></i>
                                            </div>
                                            <h3>Google Chrome</h3>
                                            <p>Google LLC</p>
                                            <div style="color:#666; font-size:11px; margin-bottom:10px;">Navegador rápido e seguro</div>
                                            <button class="store-btn" id="btn-install-chrome" onclick="wm.installApp('chrome')">Obter</button>
                                        </div>

                                        <!-- Firefox -->
                                        <div class="store-card">
                                            <div class="store-icon-box" style="background:#fff2f0">
                                                <i class="fab fa-firefox-browser" style="font-size:40px; color:#ff7139"></i>
                                            </div>
                                            <h3>Mozilla Firefox</h3>
                                            <p>Mozilla Foundation</p>
                                            <div style="color:#666; font-size:11px; margin-bottom:10px;">Privacidade em primeiro lugar</div>
                                            <button class="store-btn" id="btn-install-firefox" onclick="wm.installApp('firefox')">Obter</button>
                                        </div>

                                    </div>

                                    <div class="store-section-title" style="margin-top:30px">Jogos Populares</div>
                                    <div class="store-grid">
                                        <div class="store-card" onclick="wm.openWindow('hub')">
                                            <div class="store-icon-box" style="background:#e8f5e9">
                                                <i class="fas fa-gamepad" style="font-size:40px; color:#4caf50"></i>
                                            </div>
                                            <h3>Gaming Hub</h3>
                                            <p>Microsoft Studios</p>
                                            <button class="store-btn">Abrir</button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        `
                    },
                    'settings': { title: 'Painel de Controlo', icon: 'fa-cog', w: 600, h: 520, content: this.settingsPages.menu },
                    'hub': {
                        title: 'Gaming Hub',
                        icon: 'fa-gamepad',
                        w: 500,
                        h: 400,
                        content: `
                            <div class="hub-container">
                                <div style="font-size:18px; color:#003399; margin-bottom:20px; font-weight:bold; border-bottom:1px solid #ccc; padding-bottom:10px">Explorador de Jogos</div>
                                <div class="hub-grid">
                                    <div class="hub-item" onclick="wm.openWindow('snake'); wm.closeWindow(this.closest('.window').id)">
                                        <i class="fas fa-worm" style="color:#2ecc71"></i>
                                        <span>Snake Clássico</span>
                                    </div>
                                    <div class="hub-item" onclick="wm.openWindow('maze'); wm.closeWindow(this.closest('.window').id)">
                                        <i class="fas fa-route" style="color:#e67e22"></i>
                                        <span>Labirinto Infinito</span>
                                    </div>
                                    <div class="hub-item" onclick="wm.openWindow('memory'); wm.closeWindow(this.closest('.window').id)">
                                        <i class="fas fa-th-large" style="color:#9b59b6"></i>
                                        <span>Memória</span>
                                    </div>
                                    <div class="hub-item" onclick="wm.openWindow('paint'); wm.closeWindow(this.closest('.window').id)">
                                        <i class="fas fa-paint-brush" style="color:#e74c3c"></i>
                                        <span>Paint</span>
                                    </div>
                                </div>
                            </div>
                        `
                    },
                    'explorer': { 
                        title: 'Explorador de Ficheiros', 
                        icon: 'fa-folder', 
                        w: 750, 
                        h: 500, 
                        content: `
                            <div class="explorer-top">
                                <div class="win-btn" style="width:24px; height:24px"><i class="fas fa-arrow-left"></i></div>
                                <div class="win-btn" style="width:24px; height:24px"><i class="fas fa-arrow-right"></i></div>
                                <div class="explorer-bar"><i class="fas fa-folder" style="margin-right:5px; color:#f39c12"></i> Bibliotecas > Documentos</div>
                            </div>
                            <div class="explorer-container">
                                <div class="explorer-sidebar">
                                    <div style="font-weight:bold; margin-bottom:5px; color:#555">Favoritos</div>
                                    <div class="explorer-tree-item"><i class="fas fa-desktop" style="color:#5bc0de"></i> Desktop</div>
                                    <div class="explorer-tree-item"><i class="fas fa-download" style="color:#5bc0de"></i> Downloads</div>
                                </div>
                                <div class="explorer-main">
                                    <div class="explorer-item"><i class="fas fa-folder"></i><span>Trabalho</span></div>
                                    <div class="explorer-item"><i class="fas fa-folder"></i><span>Fotos 2024</span></div>
                                </div>
                            </div>
                        `
                    },
                    'run': {
                        title: 'Executar',
                        icon: 'img',
                        w: 400,
                        h: 210,
                        content: `
                            <div class="run-box">
                                <div class="run-header">
                                    <img src="https://www.tenforums.com/geek/gars/images/2/types/thumb__un.png" class="run-icon-large">
                                    <div class="run-prompt">Digite o nome de um programa, pasta, documento ou recurso da Internet.</div>
                                </div>
                                <div class="run-input-area">
                                    <label style="color:#000"><u>A</u>brir:</label>
                                    <input type="text" class="run-field" id="run-input" autofocus>
                                </div>
                                <div class="run-actions">
                                    <button class="win7-btn" id="run-ok-btn" onclick="wm.handleRun(this)">OK</button>
                                    <button class="win7-btn" onclick="wm.closeWindow(this.closest('.window').id)">Cancelar</button>
                                </div>
                            </div>
                        `,
                        onOpen: (id) => {
                            const input = document.getElementById('run-input');
                            if(input) {
                                input.focus();
                                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') wm.handleRun(input); });
                            }
                        }
                    },
                    'paint': {
                        title: 'Paint',
                        icon: 'fa-paint-brush',
                        w: 700,
                        h: 500,
                        content: `
                            <div class="paint-container">
                                <div class="paint-toolbar">
                                    <div class="color-picker">
                                        <div class="color-box active" style="background:#000" onclick="wm.setPaintColor(this, '#000')"></div>
                                        <div class="color-box" style="background:#fff" onclick="wm.setPaintColor(this, '#fff')"></div>
                                        <div class="color-box" style="background:#ff0000" onclick="wm.setPaintColor(this, '#ff0000')"></div>
                                        <div class="color-box" style="background:#00ff00" onclick="wm.setPaintColor(this, '#00ff00')"></div>
                                        <div class="color-box" style="background:#0000ff" onclick="wm.setPaintColor(this, '#0000ff')"></div>
                                        <div class="color-box" style="background:#ffff00" onclick="wm.setPaintColor(this, '#ffff00')"></div>
                                        <div class="color-box" style="background:#ff00ff" onclick="wm.setPaintColor(this, '#ff00ff')"></div>
                                        <div class="color-box" style="background:#00ffff" onclick="wm.setPaintColor(this, '#00ffff')"></div>
                                        <div class="color-box" style="background:#800000" onclick="wm.setPaintColor(this, '#800000')"></div>
                                        <div class="color-box" style="background:#008000" onclick="wm.setPaintColor(this, '#008000')"></div>
                                    </div>
                                    <div style="border-left:1px solid #aaa; height:30px"></div>
                                    <div style="font-size:11px; display:flex; flex-direction:column; gap:2px">
                                        <span>Tamanho:</span>
                                        <input type="range" min="1" max="20" value="2" style="width:60px" onchange="wm.setPaintSize(this)">
                                    </div>
                                    <div style="border-left:1px solid #aaa; height:30px"></div>
                                    <div class="tool-btn" onclick="wm.clearPaint(this)" title="Limpar Tela"><i class="fas fa-trash"></i></div>
                                </div>
                                <div class="paint-canvas-area">
                                    <canvas width="600" height="400" class="paint-canvas"></canvas>
                                </div>
                            </div>
                        `,
                        onOpen: initPaint
                    },
                    'cmd': {
                        title: 'Linha de Comandos',
                        icon: 'fa-terminal',
                        w: 500,
                        h: 300,
                        content: `
                            <div class="cmd-container" onclick="this.querySelector('input').focus()">
                                <div class="cmd-log">Microsoft Windows [Versão 6.1.7601]<br>Copyright (c) 2009 Microsoft Corporation. Todos os direitos reservados.<br><br></div>
                                <div class="cmd-input-line">
                                    <span>C:\\Users\\Usuário></span>
                                    <input type="text" class="cmd-input" onkeydown="wm.handleCmd(event, this)">
                                </div>
                            </div>
                        `
                    },
                    'snake': { title: 'Snake Game', icon: 'fa-gamepad', w: 320, h: 420, content: '<div class="score-board">Score: <span id="s-score">0</span></div><canvas id="snake-canvas" width="300" height="300"></canvas>', onOpen: initSnake },
                    'maze': { title: 'Labirinto Infinito', icon: 'fa-route', w: 500, h: 600, content: `
                        <div id="maze-container">
                            <div class="maze-stats">
                                <span>Nível: <span id="maze-level">1</span></span>
                                <span>Movimentos: <span id="maze-moves">0</span></span>
                            </div>
                            <canvas id="maze-canvas"></canvas>
                            <div style="color:#888; font-size:10px; margin:10px; text-align:center">Usa as setas do teclado para navegar.<br>O labirinto cresce a cada nível!</div>
                        </div>
                    `, onOpen: initMazeApp },
                    'memory': { title: 'Jogo da Memória', icon: 'fa-th-large', w: 350, h: 450, content: '<div class="score-board">Pares: <span id="m-score">0</span></div><div class="memory-grid" id="memory-grid"></div>', onOpen: initMemory },
                    'calc': {
                        title: 'Calculadora',
                        icon: 'fa-calculator',
                        w: 260,
                        h: 360,
                        content: `
                            <div class="calc-body">
                                <div class="calc-display" id="calc-res">0</div>
                                <div class="calc-grid">
                                    <div class="calc-btn" onclick="wm.calc('C')">C</div>
                                    <div class="calc-btn" onclick="wm.calc('CE')">CE</div>
                                    <div class="calc-btn op" onclick="wm.calc('/')">÷</div>
                                    <div class="calc-btn op" onclick="wm.calc('*')">×</div>
                                    <div class="calc-btn" onclick="wm.calc('7')">7</div>
                                    <div class="calc-btn" onclick="wm.calc('8')">8</div>
                                    <div class="calc-btn" onclick="wm.calc('9')">9</div>
                                    <div class="calc-btn op" onclick="wm.calc('-')">-</div>
                                    <div class="calc-btn" onclick="wm.calc('4')">4</div>
                                    <div class="calc-btn" onclick="wm.calc('5')">5</div>
                                    <div class="calc-btn" onclick="wm.calc('6')">6</div>
                                    <div class="calc-btn op" onclick="wm.calc('+')">+</div>
                                    <div class="calc-btn" onclick="wm.calc('1')">1</div>
                                    <div class="calc-btn" onclick="wm.calc('2')">2</div>
                                    <div class="calc-btn" onclick="wm.calc('3')">3</div>
                                    <div class="calc-btn eq" onclick="wm.calc('=')">=</div>
                                    <div class="calc-btn" style="grid-column: span 2" onclick="wm.calc('0')">0</div>
                                    <div class="calc-btn" onclick="wm.calc('.')">.</div>
                                </div>
                            </div>
                        `
                    },
                    'computer': { title: 'Computador', icon: 'fa-desktop', w: 600, h: 400, content: `<div class="explorer-top"><div class="explorer-bar"><i class="fas fa-desktop"></i> Computador</div></div><div style="padding:20px; background:#fff; height:calc(100% - 35px)">Disco Local (C:) <div style="width:200px; height:15px; background:#eee; border:1px solid #aaa; margin-top:5px"><div style="width:40%; height:100%; background:linear-gradient(to right, #5bc0de, #2a88ad)"></div></div><span style="font-size:11px; color:#555">60 GB livres de 100 GB</span></div>` }
                };
            
                // Paint State
                this.paintColor = '#000';
                this.paintSize = 2;
                this.currentCanvas = null;
            }

            // --- Context Menu Actions ---
            closeContext() {
                document.getElementById('context-menu').style.display = 'none';
            }

            resizeIcons(size) {
                const icons = document.querySelectorAll('.desktop-icon');
                let scale = 1;
                let checkId = 'check-medium';
                
                if (size === 'small') { scale = 0.8; checkId = 'check-small'; }
                if (size === 'large') { scale = 1.3; checkId = 'check-large'; }

                icons.forEach(icon => icon.style.transform = `scale(${scale})`);

                // Update checkmarks
                document.getElementById('check-small').innerHTML = '';
                document.getElementById('check-medium').innerHTML = '';
                document.getElementById('check-large').innerHTML = '';
                document.getElementById(checkId).innerHTML = '●';
            }

            toggleIcons() {
                const icons = document.querySelectorAll('.desktop-icon');
                this.iconsVisible = !this.iconsVisible;
                icons.forEach(icon => icon.style.display = this.iconsVisible ? 'flex' : 'none');
                document.getElementById('check-visible').innerHTML = this.iconsVisible ? '✓' : '';
            }

            navSettings(pageId) {
                const windows = document.querySelectorAll('.window');
                let settingsWin = null;
                windows.forEach(w => { if (w.style.display !== 'none' && w.querySelector('.window-title').innerText.includes('Painel de Controlo')) settingsWin = w; });
                if (settingsWin && this.settingsPages[pageId]) settingsWin.querySelector('.window-content').innerHTML = this.settingsPages[pageId];
            }

            installApp(app) {
                const btn = document.getElementById('btn-install-' + app);
                if (btn) {
                    btn.disabled = true;
                    btn.innerText = "A descarregar...";
                    
                    // Simulate download delay
                    setTimeout(() => {
                        btn.innerText = "A instalar...";
                        setTimeout(() => {
                            btn.innerText = "Abrir";
                            btn.disabled = false;
                            btn.onclick = () => wm.openWindow(app);
                            
                            // Add to Desktop
                            if(app === 'chrome') this.addDesktopIcon('Google Chrome', 'fab fa-chrome', 'chrome', '#ea4335');
                            if(app === 'firefox') this.addDesktopIcon('Firefox', 'fab fa-firefox-browser', 'firefox', '#ff7139');
                            
                            alert(`${app === 'chrome' ? 'Google Chrome' : 'Mozilla Firefox'} foi instalado com sucesso!`);
                        }, 1500);
                    }, 1500);
                }
            }
            
            addDesktopIcon(title, iconClass, appId, color) {
                const desk = document.getElementById('desktop');
                const existing = desk.querySelectorAll('.desktop-icon').length;
                const newIcon = document.createElement('div');
                newIcon.className = 'desktop-icon';
                newIcon.style.top = (10 + Math.floor(existing/4) * 100) + 'px'; // Simple layout logic override, creates pile if too many but works for demo
                // Better dynamic positioning for demo:
                // Find first free spot? Just stack for now, user can imagine.
                // Let's put it in the next column slot if possible or just stack at bottom
                newIcon.style.top = '210px'; 
                newIcon.style.left = '200px'; 
                if(appId === 'firefox') { newIcon.style.left = '290px'; }

                newIcon.onclick = () => this.openWindow(appId);
                newIcon.innerHTML = `<i class="${iconClass}" style="color:${color}"></i><span>${title}</span>`;
                desk.appendChild(newIcon);
            }

            openWindow(appId) {
                const config = this.appConfigs[appId];
                if (!config) return;
                const id = 'win_' + Date.now();
                const win = document.createElement('div');
                win.className = 'window';
                win.id = id;
                win.style.width = config.w + 'px';
                win.style.height = config.h + 'px';
                win.style.top = (60 + (Object.keys(this.windows).length * 15)) + 'px';
                win.style.left = (80 + (Object.keys(this.windows).length * 15)) + 'px';
                win.style.zIndex = ++this.zIndex;
                let headerIcon = appId === 'run' ? `<img src="${this.runImgUrl}" style="width:16px; height:16px">` : `<i class="${config.icon.includes('fab') ? config.icon : 'fas ' + config.icon}"></i>`;
                win.innerHTML = `<div class="window-header" onmousedown="wm.drag(event, '${id}')"><div class="window-title">${headerIcon} ${config.title}</div><div class="win-controls"><div class="win-btn" onclick="wm.minWindow('${id}')">_</div><div class="win-btn">□</div><div class="win-btn win-close" onclick="wm.closeWindow('${id}')">✕</div></div></div><div class="window-content">${config.content}</div>`;
                document.getElementById('desktop').appendChild(win);
                this.windows[id] = win;
                this.addTask(id, config.title, config.icon, appId === 'run');
                if (config.onOpen) config.onOpen(id);
            }

            handleRun(el) {
                const input = document.getElementById('run-input');
                if (!input) return;
                const cmd = input.value.trim().toLowerCase();
                const cmdMap = { 'calc': 'calc', 'notepad': 'notepad', 'chrome': 'browser', 'explorer': 'explorer', 'control': 'settings', 'snake': 'snake', 'maze': 'maze', 'memory': 'memory', 'hub': 'hub', 'paint': 'paint', 'cmd': 'cmd', 'bsod': 'bsod', 'store': 'store' };
                if (cmd === 'bsod') { this.triggerBSOD(); this.closeWindow(el.closest('.window')?.id); return; }
                const targetApp = cmdMap[cmd];
                if (targetApp) { this.closeWindow(el.closest('.window')?.id); this.openWindow(targetApp); }
                else if (cmd !== "") alert(`Não foi possível encontrar '${cmd}'.`);
            }

            handleCmd(e, input) {
                if(e.key === 'Enter') {
                    const val = input.value.trim();
                    const log = input.closest('.cmd-container').querySelector('.cmd-log');
                    const line = document.createElement('div');
                    line.innerText = `C:\\Users\\Usuário> ${val}`;
                    log.appendChild(line);
                    
                    // Simple CMD Logic
                    const cmd = val.toLowerCase().split(' ')[0];
                    let response = "";
                    if(cmd === 'help') response = "Comandos disponíveis: help, ver, date, echo [texto], cls, bsod, exit";
                    else if(cmd === 'ver') response = "Microsoft Windows [Versão 6.1.7601]";
                    else if(cmd === 'date') response = new Date().toString();
                    else if(cmd === 'cls') { log.innerHTML = ''; input.value = ''; return; }
                    else if(cmd === 'echo') response = val.substring(5);
                    else if(cmd === 'bsod') { this.triggerBSOD(); response = "A iniciar crash do sistema..."; }
                    else if(cmd === 'exit') { this.closeWindow(input.closest('.window').id); return; }
                    else if(val !== "") response = `'${cmd}' não é reconhecido como um comando interno ou externo.`;

                    if(response) {
                        const respDiv = document.createElement('div');
                        respDiv.innerText = response;
                        respDiv.style.marginBottom = "10px";
                        log.appendChild(respDiv);
                    } else if (val !== "") {
                        const spacer = document.createElement('div');
                        spacer.style.height = "10px";
                        log.appendChild(spacer);
                    }

                    input.value = '';
                    log.scrollTop = log.scrollHeight;
                }
            }

            triggerBSOD() {
                const bsod = document.getElementById('bsod');
                bsod.style.display = (document.body.classList.contains('theme-win8') || document.body.classList.contains('theme-win10')) ? 'flex' : 'block';
                
                const isWin8 = document.body.classList.contains('theme-win8');
                const isWin10 = document.body.classList.contains('theme-win10');
                const isWin11 = document.body.classList.contains('theme-win11');
                const legacyText = bsod.querySelectorAll('.legacy-bsod');
                
                // Win11 and Win8 use "Sad Face", older use Text
                legacyText.forEach(el => el.style.display = (isWin8 || isWin10 || isWin11) ? 'none' : 'block');
            }

            addTask(id, title, icon, isRun = false) {
                const task = document.createElement('div');
                task.className = 'task-item active';
                task.id = 'task_' + id;
                let iconHtml = isRun ? `<img src="${this.runImgUrl}" style="width:16px; height:16px; margin-right:8px">` : `<i class="${icon.includes('fab') ? icon : 'fas ' + icon}" style="margin-right:8px"></i>`;
                task.innerHTML = `${iconHtml} <span style="font-size:11px">${title}</span>`;
                task.onclick = () => this.focusWindow(id);
                document.getElementById('task-container').appendChild(task);
            }

            focusWindow(id) {
                const win = this.windows[id];
                if (win) {
                    win.style.display = 'flex';
                    win.style.zIndex = ++this.zIndex;
                    document.querySelectorAll('.task-item').forEach(t => t.classList.remove('active'));
                    document.getElementById('task_' + id)?.classList.add('active');
                }
            }
            
            minWindow(id) { this.windows[id].style.display = 'none'; document.getElementById('task_' + id)?.classList.remove('active'); }
            closeWindow(id) { if (this.windows[id]) { this.windows[id].remove(); delete this.windows[id]; document.getElementById('task_' + id)?.remove(); } }

            drag(e, id) {
                if (e.target.closest('.win-controls')) return;
                const win = this.windows[id];
                this.focusWindow(id);
                let startX = e.clientX - win.offsetLeft, startY = e.clientY - win.offsetTop;
                const move = ev => { win.style.left = (ev.clientX - startX) + 'px'; win.style.top = (ev.clientY - startY) + 'px'; };
                const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stop);
            }

            calc(val) {
                const display = document.getElementById('calc-res');
                if (val === 'C' || val === 'CE') this.calcMemory = "";
                else if (val === '=') { try { this.calcMemory = eval(this.calcMemory).toString(); } catch { this.calcMemory = "Erro"; } }
                else { if(this.calcMemory === "Erro") this.calcMemory = ""; this.calcMemory += val; }
                display.innerText = this.calcMemory || "0";
            }

            goBack(e) { try { e.target.closest('.window').querySelector('iframe').contentWindow.history.back(); } catch {} }
            reloadIframe(e) { const f = e.target.closest('.window').querySelector('iframe'); f.src = f.src; }
            setBg(url) { document.getElementById('desktop').style.backgroundImage = `url('${url}')`; }
            handleBgUpload(input) { if (input.files[0]) { const r = new FileReader(); r.onload = e => this.setBg(e.target.result); r.readAsDataURL(input.files[0]); } }
            
            setTheme(c) {
                const r = document.documentElement;
                const body = document.body;
                
                // Clear Previous Classes
                body.classList.remove('theme-xp', 'theme-win8', 'theme-aero', 'theme-win11', 'theme-win10');

                if (c === 'luna') {
                    body.classList.add('theme-xp');
                    r.style.setProperty('--glass-color', '#ece9d8'); 
                    r.style.setProperty('--glass-border', '#0055ea');
                } else if (c === 'win8') {
                    body.classList.add('theme-win8');
                } else if (c === 'win10') {
                    body.classList.add('theme-win10');
                } else if (c === 'win11') {
                    body.classList.add('theme-win11');
                } else {
                    // Default / Aero / Color variants
                    body.classList.add('theme-aero');
                    this.setThemeColor(c);
                }
            }

            setThemeColor(c) {
                const r = document.documentElement;
                const colors = {
                    red: ['rgba(192, 57, 43, 0.65)', 'rgba(150, 40, 30, 0.9)'],
                    green: ['rgba(39, 174, 96, 0.65)', 'rgba(25, 140, 70, 0.9)'],
                    purple: ['rgba(75, 44, 137, 0.65)', 'rgba(50, 25, 100, 0.9)'],
                    blue: ['rgba(0, 120, 215, 0.65)', 'rgba(0, 80, 180, 0.9)'],
                    orange: ['rgba(230, 126, 34, 0.65)', 'rgba(200, 100, 20, 0.9)'],
                    dark: ['rgba(44, 62, 80, 0.75)', 'rgba(30, 45, 60, 0.95)'],
                    default: ['rgba(20, 30, 50, 0.65)', 'rgba(10, 20, 35, 0.9)']
                };
                if (colors[c]) {
                    r.style.setProperty('--glass-color', colors[c][0]);
                    r.style.setProperty('--taskbar-color', colors[c][1]);
                }
            }

            setDarkMode(isDark) {
                if (isDark) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }
            
            setWin8Color(color) {
                // Sets accent color for Windows 8 Theme
                const r = document.documentElement;
                r.style.setProperty('--win8-accent', color);
                // Switch to Win8 Theme if not active
                if (!document.body.classList.contains('theme-win8')) {
                    this.setTheme('win8');
                }
            }

            updateUsername() { 
                const val = document.getElementById('username-input').value;
                document.getElementById('start-username-display').querySelector('span').innerText = val;
                document.getElementById('xp-username').innerText = val;
                document.getElementById('win8-username').innerText = val;
                document.getElementById('win11-username').innerText = val;
            }

            // Paint Functions
            setPaintColor(el, c) {
                this.paintColor = c;
                el.parentElement.querySelectorAll('.color-box').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
            setPaintSize(el) { this.paintSize = el.value; }
            clearPaint(el) {
                const canvas = el.closest('.paint-container').querySelector('canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,canvas.width, canvas.height);
            }
        }

        const wm = new WindowManager();

        // --- Init Functions ---
        
        function initPaint(id) {
            const container = document.getElementById(id).querySelector('.paint-container');
            const canvas = container.querySelector('canvas');
            const ctx = canvas.getContext('2d');
            let painting = false;

            function startPosition(e) {
                painting = true;
                draw(e);
            }
            function endPosition() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if (!painting) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineWidth = wm.paintSize;
                ctx.lineCap = 'round';
                ctx.strokeStyle = wm.paintColor;
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mouseup', endPosition);
            canvas.addEventListener('mousemove', draw);
            // Default background white
            ctx.fillStyle = "#fff";
            ctx.fillRect(0,0,canvas.width,canvas.height);
        }

        function initSnake(id) {
            const canvas = document.getElementById(id).querySelector('#snake-canvas');
            const ctx = canvas.getContext('2d');
            let snake = [{x:10,y:10}], food = {x:5,y:5}, dx=1, dy=0, score=0;
            const loop = setInterval(() => {
                if (!document.getElementById(id)) return clearInterval(loop);
                let head = {x:snake[0].x+dx, y:snake[0].y+dy};
                if(head.x<0) head.x=29; if(head.x>29) head.x=0; if(head.y<0) head.y=29; if(head.y>29) head.y=0;
                snake.unshift(head);
                if(head.x===food.x && head.y===food.y) { score+=10; document.getElementById(id).querySelector('#s-score').innerText=score; food={x:Math.floor(Math.random()*30),y:Math.floor(Math.random()*30)}; } else snake.pop();
                ctx.fillStyle='#111'; ctx.fillRect(0,0,300,300);
                ctx.fillStyle='lime'; snake.forEach(s=>ctx.fillRect(s.x*10,s.y*10,9,9));
                ctx.fillStyle='red'; ctx.fillRect(food.x*10,food.y*10,9,9);
            }, 100);
            const handler = e => {
                if(e.key==='ArrowUp'&&dy===0){dx=0;dy=-1;} if(e.key==='ArrowDown'&&dy===0){dx=0;dy=1;}
                if(e.key==='ArrowLeft'&&dx===0){dx=-1;dy=0;} if(e.key==='ArrowRight'&&dx===0){dx=1;dy=0;}
            };
            document.addEventListener('keydown', handler);
        }

        // Infinite Maze Logic
        function initMazeApp(winId) {
            const canvas = document.getElementById(winId).querySelector('#maze-canvas');
            const levelEl = document.getElementById(winId).querySelector('#maze-level');
            const movesEl = document.getElementById(winId).querySelector('#maze-moves');
            const ctx = canvas.getContext('2d');
            let level = 1, moves = 0, cols, rows, cellSize, grid = [], player = {x:0,y:0}, goal = {x:0,y:0};

            function setupLevel() {
                cols = 15 + ((level - 1) * 5); rows = cols;
                const desiredSize = 380;
                cellSize = Math.floor(desiredSize / cols);
                if (cellSize < 10) cellSize = 10;
                canvas.width = cols * cellSize; canvas.height = rows * cellSize;
                grid = generateMaze(cols, rows);
                player = {x:0, y:0}; goal = {x:cols-1, y:rows-1};
                moves = 0; levelEl.innerText = level; movesEl.innerText = moves;
                draw();
            }

            function generateMaze(w, h) {
                let maze = Array(h).fill().map(() => Array(w).fill().map(() => ({ visited: false, walls: [true, true, true, true] })));
                let stack = [], current = { x: 0, y: 0 };
                maze[0][0].visited = true;
                let unvisitedCount = (w * h) - 1;
                while (unvisitedCount > 0) {
                    let neighbors = [];
                    if (current.y > 0 && !maze[current.y - 1][current.x].visited) neighbors.push({x: current.x, y: current.y - 1, dir: 0});
                    if (current.x < w - 1 && !maze[current.y][current.x + 1].visited) neighbors.push({x: current.x + 1, y: current.y, dir: 1});
                    if (current.y < h - 1 && !maze[current.y + 1][current.x].visited) neighbors.push({x: current.x, y: current.y + 1, dir: 2});
                    if (current.x > 0 && !maze[current.y][current.x - 1].visited) neighbors.push({x: current.x - 1, y: current.y, dir: 3});
                    if (neighbors.length > 0) {
                        let next = neighbors[Math.floor(Math.random() * neighbors.length)];
                        maze[current.y][current.x].walls[next.dir] = false;
                        maze[next.y][next.x].walls[(next.dir + 2) % 4] = false;
                        stack.push(current); current = next; maze[current.y][current.x].visited = true; unvisitedCount--;
                    } else if (stack.length > 0) current = stack.pop();
                    else break;
                }
                return maze;
            }

            function draw() {
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.lineWidth = 1; ctx.strokeStyle = '#444';
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        let cell = grid[y][x], px = x * cellSize, py = y * cellSize;
                        ctx.beginPath();
                        if (cell.walls[0]) { ctx.moveTo(px, py); ctx.lineTo(px + cellSize, py); }
                        if (cell.walls[1]) { ctx.moveTo(px + cellSize, py); ctx.lineTo(px + cellSize, py + cellSize); }
                        if (cell.walls[2]) { ctx.moveTo(px + cellSize, py + cellSize); ctx.lineTo(px, py + cellSize); }
                        if (cell.walls[3]) { ctx.moveTo(px, py + cellSize); ctx.lineTo(px, py); }
                        ctx.stroke();
                    }
                }
                ctx.fillStyle = '#f1c40f'; ctx.fillRect(goal.x * cellSize + 2, goal.y * cellSize + 2, cellSize - 4, cellSize - 4);
                ctx.fillStyle = '#00f0ff'; ctx.shadowBlur = 5; ctx.shadowColor = "#00f0ff";
                ctx.beginPath(); ctx.arc(player.x * cellSize + cellSize / 2, player.y * cellSize + cellSize / 2, cellSize / 2 - 2, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
            }

            const moveHandler = (e) => {
                if (!document.getElementById(winId)) { document.removeEventListener('keydown', moveHandler); return; }
                if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) e.preventDefault();
                let cx = player.x, cy = player.y, moved = false;
                if (e.key === 'ArrowUp' && !grid[cy][cx].walls[0]) { player.y--; moved = true; }
                else if (e.key === 'ArrowRight' && !grid[cy][cx].walls[1]) { player.x++; moved = true; }
                else if (e.key === 'ArrowDown' && !grid[cy][cx].walls[2]) { player.y++; moved = true; }
                else if (e.key === 'ArrowLeft' && !grid[cy][cx].walls[3]) { player.x--; moved = true; }
                if (moved) {
                    moves++; movesEl.innerText = moves;
                    const container = document.getElementById(winId).querySelector('#maze-container');
                    const pY = player.y * cellSize;
                    if (pY > container.scrollTop + container.clientHeight - 50) container.scrollTop = pY - container.clientHeight / 2;
                    if (pY < container.scrollTop + 50) container.scrollTop = pY - container.clientHeight / 2;
                    draw();
                    if (player.x === goal.x && player.y === goal.y) { level++; setTimeout(setupLevel, 200); }
                }
            };
            document.addEventListener('keydown', moveHandler);
            setupLevel();
        }

        // Memory Game
        function initMemory(id) {
            const grid = document.getElementById(id).querySelector('#memory-grid');
            const icons = ['fa-ghost', 'fa-robot', 'fa-dragon', 'fa-rocket', 'fa-star', 'fa-heart', 'fa-apple-whole', 'fa-bolt'];
            let cards = [...icons, ...icons].sort(() => Math.random() - 0.5);
            let flipped = [], matched = 0;
            cards.forEach((icon, i) => {
                const card = document.createElement('div'); card.className = 'memory-card';
                card.innerHTML = `<i class="fas ${icon}" style="display:none"></i>`;
                card.onclick = () => {
                    if (flipped.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped'); card.querySelector('i').style.display = 'block'; flipped.push(card);
                        if (flipped.length === 2) {
                            if (flipped[0].innerHTML === flipped[1].innerHTML) {
                                flipped.forEach(c => c.classList.add('matched')); flipped = []; matched++; document.getElementById(id).querySelector('#m-score').innerText = matched;
                                if(matched === 8) alert("Incrível! Memória de elefante!");
                            } else setTimeout(() => { flipped.forEach(c => { c.classList.remove('flipped'); c.querySelector('i').style.display = 'none'; }); flipped = []; }, 1000);
                        }
                    }
                };
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>
